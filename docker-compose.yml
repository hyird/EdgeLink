version: '3.8'

services:
  # ==========================================================================
  # Controller - Central management and API
  # ==========================================================================
  controller:
    image: ${DOCKERHUB_USERNAME:-edgelink}/edgelink-controller:${TAG:-latest}
    build:
      context: .
      dockerfile: Dockerfile
      target: controller
    container_name: edgelink-controller
    restart: unless-stopped
    ports:
      - "8080:8080"   # HTTP API
      - "8443:8443"   # HTTPS/WSS Control
    volumes:
      - ./config/controller.json:/app/config/controller.json:ro
      - controller-data:/app/data
    environment:
      - TZ=Asia/Shanghai
    networks:
      - edgelink-net

  # ==========================================================================
  # Server - Relay and STUN server
  # ==========================================================================
  server:
    image: ${DOCKERHUB_USERNAME:-edgelink}/edgelink-server:${TAG:-latest}
    build:
      context: .
      dockerfile: Dockerfile
      target: server
    container_name: edgelink-server
    restart: unless-stopped
    ports:
      - "9443:9443"       # Relay WebSocket
      - "3478:3478/udp"   # STUN UDP
    volumes:
      - ./config/server.json:/app/config/server.json:ro
    environment:
      - TZ=Asia/Shanghai
    depends_on:
      - controller
    networks:
      - edgelink-net

  # ==========================================================================
  # Client - VPN client (requires privileged mode for TUN)
  # ==========================================================================
  client:
    image: ${DOCKERHUB_USERNAME:-edgelink}/edgelink-client:${TAG:-latest}
    build:
      context: .
      dockerfile: Dockerfile
      target: client
    container_name: edgelink-client
    restart: unless-stopped
    privileged: true
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    devices:
      - /dev/net/tun:/dev/net/tun
    volumes:
      - ./config/client.json:/app/config/client.json:ro
    environment:
      - TZ=Asia/Shanghai
    sysctls:
      - net.ipv4.ip_forward=1
    networks:
      - edgelink-net

volumes:
  controller-data:

networks:
  edgelink-net:
    driver: bridge
