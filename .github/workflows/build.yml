name: Build EdgeLink

on:
  push:
    branches: [ main, master, develop, 'claude/*' ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  # =============================================================================
  # Linux Release Build - Alpine musl (Full Static)
  # =============================================================================
  build-linux-release:
    runs-on: ubuntu-latest
    container:
      image: alpine:3.20

    steps:
    - name: Install Dependencies
      run: |
        apk add --no-cache \
          build-base cmake ninja git curl zip unzip tar \
          pkgconfig linux-headers musl-dev perl bash python3 \
          autoconf automake libtool go

    - uses: actions/checkout@v4

    - name: Cache build
      uses: actions/cache@v4
      with:
        path: build-release
        key: build-linux-release-v3-${{ hashFiles('third_party/*.cmake', 'CMakeLists.txt') }}
        restore-keys: |
          build-linux-release-v3-${{ hashFiles('third_party/*.cmake', 'CMakeLists.txt') }}

    - name: Configure CMake
      run: |
        cmake -B build-release -G Ninja \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_POLICY_VERSION_MINIMUM=3.5 \
          -DBUILD_SHARED_LIBS=OFF \
          -DEDGELINK_STATIC=ON \
          -DBUILD_CONTROLLER=ON \
          -DBUILD_SERVER=OFF \
          -DBUILD_CLIENT=ON

    - name: Build
      run: cmake --build build-release --config Release -j $(nproc)

    - name: Verify Static Linking
      run: |
        echo "=== File info ==="
        file build-release/edgelink-* || true
        echo "=== Dynamic dependencies ==="
        ldd build-release/edgelink-controller 2>&1 || echo "Fully static binary (expected)"

    - name: Package Artifacts
      run: |
        mkdir -p artifacts/linux
        cp build-release/edgelink-controller artifacts/linux/ || true
        cp build-release/edgelink-client artifacts/linux/ || true
        cp -r config artifacts/linux/
        tar -czvf edgelink-linux-x64-release.tar.gz -C artifacts linux

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: edgelink-linux-x64-release
        path: edgelink-linux-x64-release.tar.gz
        retention-days: 30

  # =============================================================================
  # Linux Debug Build - Alpine musl (Full Static)
  # =============================================================================
  build-linux-debug:
    runs-on: ubuntu-latest
    container:
      image: alpine:3.20

    steps:
    - name: Install Dependencies
      run: |
        apk add --no-cache \
          build-base cmake ninja git curl zip unzip tar \
          pkgconfig linux-headers musl-dev perl bash python3 \
          autoconf automake libtool go

    - uses: actions/checkout@v4

    - name: Cache build
      uses: actions/cache@v4
      with:
        path: build-debug
        key: build-linux-debug-v3-${{ hashFiles('third_party/*.cmake', 'CMakeLists.txt') }}
        restore-keys: |
          build-linux-debug-v3-${{ hashFiles('third_party/*.cmake', 'CMakeLists.txt') }}

    - name: Configure CMake
      run: |
        cmake -B build-debug -G Ninja \
          -DCMAKE_BUILD_TYPE=Debug \
          -DCMAKE_POLICY_VERSION_MINIMUM=3.5 \
          -DBUILD_SHARED_LIBS=OFF \
          -DEDGELINK_STATIC=ON \
          -DBUILD_CONTROLLER=ON \
          -DBUILD_SERVER=OFF \
          -DBUILD_CLIENT=ON

    - name: Build
      run: cmake --build build-debug --config Debug -j $(nproc)

    - name: Verify Static Linking
      run: |
        echo "=== File info ==="
        file build-debug/edgelink-* || true
        echo "=== Dynamic dependencies ==="
        ldd build-debug/edgelink-controller 2>&1 || echo "Fully static binary (expected)"

    - name: Package Artifacts
      run: |
        mkdir -p artifacts/linux
        cp build-debug/edgelink-controller artifacts/linux/ || true
        cp build-debug/edgelink-client artifacts/linux/ || true
        cp -r config artifacts/linux/
        tar -czvf edgelink-linux-x64-debug.tar.gz -C artifacts linux

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: edgelink-linux-x64-debug
        path: edgelink-linux-x64-debug.tar.gz
        retention-days: 30

  # =============================================================================
  # Windows Release Build - MinGW-w64 via MSYS2
  # =============================================================================
  build-windows-release:
    runs-on: windows-latest

    defaults:
      run:
        shell: msys2 {0}

    steps:
    - name: Setup MSYS2
      uses: msys2/setup-msys2@v2
      with:
        msystem: MINGW64
        update: true
        install: >-
          mingw-w64-x86_64-toolchain
          mingw-w64-x86_64-cmake
          mingw-w64-x86_64-ninja
          mingw-w64-x86_64-go
          make
          git
          perl
          autoconf
          automake
          libtool
          zip
          unzip

    - uses: actions/checkout@v4

    - name: Cache build
      uses: actions/cache@v4
      with:
        path: build-release
        key: build-windows-release-v3-${{ hashFiles('third_party/*.cmake', 'CMakeLists.txt') }}
        restore-keys: |
          build-windows-release-v3-${{ hashFiles('third_party/*.cmake', 'CMakeLists.txt') }}

    - name: Cache wintun
      uses: actions/cache@v4
      id: cache-wintun
      with:
        path: wintun-extract
        key: wintun-0.14.1

    - name: Download wintun
      if: steps.cache-wintun.outputs.cache-hit != 'true'
      shell: powershell
      run: |
        Invoke-WebRequest -Uri "https://www.wintun.net/builds/wintun-0.14.1.zip" -OutFile "wintun.zip"
        Expand-Archive -Path "wintun.zip" -DestinationPath "wintun-extract"

    - name: Configure CMake
      run: |
        cmake -B build-release -G Ninja \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_POLICY_VERSION_MINIMUM=3.5 \
          -DBUILD_SHARED_LIBS=OFF \
          -DBUILD_CONTROLLER=ON \
          -DBUILD_SERVER=OFF \
          -DBUILD_CLIENT=ON

    - name: Build
      run: cmake --build build-release --config Release -j $(nproc)

    - name: Package Artifacts
      shell: powershell
      run: |
        New-Item -ItemType Directory -Force -Path artifacts/windows
        Copy-Item -Path "build-release/edgelink-controller.exe" -Destination "artifacts/windows/" -ErrorAction SilentlyContinue
        Copy-Item -Path "build-release/edgelink-client.exe" -Destination "artifacts/windows/" -ErrorAction SilentlyContinue
        Copy-Item -Path "wintun-extract/wintun/bin/amd64/wintun.dll" -Destination "artifacts/windows/" -ErrorAction SilentlyContinue
        Copy-Item -Path "config" -Destination "artifacts/windows/" -Recurse
        Compress-Archive -Path "artifacts/windows/*" -DestinationPath "edgelink-windows-x64-release.zip"

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: edgelink-windows-x64-release
        path: edgelink-windows-x64-release.zip
        retention-days: 30

  # =============================================================================
  # Windows Debug Build - MinGW-w64 via MSYS2
  # =============================================================================
  build-windows-debug:
    runs-on: windows-latest

    defaults:
      run:
        shell: msys2 {0}

    steps:
    - name: Setup MSYS2
      uses: msys2/setup-msys2@v2
      with:
        msystem: MINGW64
        update: true
        install: >-
          mingw-w64-x86_64-toolchain
          mingw-w64-x86_64-cmake
          mingw-w64-x86_64-ninja
          mingw-w64-x86_64-go
          make
          git
          perl
          autoconf
          automake
          libtool
          zip
          unzip

    - uses: actions/checkout@v4

    - name: Cache build
      uses: actions/cache@v4
      with:
        path: build-debug
        key: build-windows-debug-v3-${{ hashFiles('third_party/*.cmake', 'CMakeLists.txt') }}
        restore-keys: |
          build-windows-debug-v3-${{ hashFiles('third_party/*.cmake', 'CMakeLists.txt') }}

    - name: Cache wintun
      uses: actions/cache@v4
      id: cache-wintun
      with:
        path: wintun-extract
        key: wintun-0.14.1

    - name: Download wintun
      if: steps.cache-wintun.outputs.cache-hit != 'true'
      shell: powershell
      run: |
        Invoke-WebRequest -Uri "https://www.wintun.net/builds/wintun-0.14.1.zip" -OutFile "wintun.zip"
        Expand-Archive -Path "wintun.zip" -DestinationPath "wintun-extract"

    - name: Configure CMake
      run: |
        cmake -B build-debug -G Ninja \
          -DCMAKE_BUILD_TYPE=Debug \
          -DCMAKE_POLICY_VERSION_MINIMUM=3.5 \
          -DBUILD_SHARED_LIBS=OFF \
          -DBUILD_CONTROLLER=ON \
          -DBUILD_SERVER=OFF \
          -DBUILD_CLIENT=ON

    - name: Build
      run: cmake --build build-debug --config Debug -j $(nproc)

    - name: Package Artifacts
      shell: powershell
      run: |
        New-Item -ItemType Directory -Force -Path artifacts/windows
        Copy-Item -Path "build-debug/edgelink-controller.exe" -Destination "artifacts/windows/" -ErrorAction SilentlyContinue
        Copy-Item -Path "build-debug/edgelink-client.exe" -Destination "artifacts/windows/" -ErrorAction SilentlyContinue
        Copy-Item -Path "wintun-extract/wintun/bin/amd64/wintun.dll" -Destination "artifacts/windows/" -ErrorAction SilentlyContinue
        Copy-Item -Path "config" -Destination "artifacts/windows/" -Recurse
        Compress-Archive -Path "artifacts/windows/*" -DestinationPath "edgelink-windows-x64-debug.zip"

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: edgelink-windows-x64-debug
        path: edgelink-windows-x64-debug.zip
        retention-days: 30

  # =============================================================================
  # Docker Release Build and Push
  # =============================================================================
  docker-release:
    needs: [build-linux-release]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v'))

    steps:
    - uses: actions/checkout@v4

    - name: Download Linux Artifacts
      uses: actions/download-artifact@v4
      with:
        name: edgelink-linux-x64-release
        path: .

    - name: Extract Artifacts
      run: |
        tar -xzvf edgelink-linux-x64-release.tar.gz
        cp linux/edgelink-controller docker/
        cp linux/edgelink-client docker/

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Docker meta (controller)
      id: meta-controller
      uses: docker/metadata-action@v5
      with:
        images: ${{ secrets.DOCKERHUB_USERNAME }}/edgelink-controller
        tags: |
          type=raw,value=latest

    - name: Docker meta (client)
      id: meta-client
      uses: docker/metadata-action@v5
      with:
        images: ${{ secrets.DOCKERHUB_USERNAME }}/edgelink-client
        tags: |
          type=raw,value=latest

    - name: Build and push controller
      uses: docker/build-push-action@v5
      with:
        context: docker
        file: docker/Dockerfile.controller
        push: true
        tags: ${{ steps.meta-controller.outputs.tags }}
        labels: ${{ steps.meta-controller.outputs.labels }}

    - name: Build and push client
      uses: docker/build-push-action@v5
      with:
        context: docker
        file: docker/Dockerfile.client
        push: true
        tags: ${{ steps.meta-client.outputs.tags }}
        labels: ${{ steps.meta-client.outputs.labels }}

  # =============================================================================
  # Docker Debug Build and Push
  # =============================================================================
  docker-debug:
    needs: [build-linux-debug]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v'))

    steps:
    - uses: actions/checkout@v4

    - name: Download Linux Artifacts
      uses: actions/download-artifact@v4
      with:
        name: edgelink-linux-x64-debug
        path: .

    - name: Extract Artifacts
      run: |
        tar -xzvf edgelink-linux-x64-debug.tar.gz
        cp linux/edgelink-controller docker/
        cp linux/edgelink-client docker/

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Docker meta (controller)
      id: meta-controller
      uses: docker/metadata-action@v5
      with:
        images: ${{ secrets.DOCKERHUB_USERNAME }}/edgelink-controller
        tags: |
          type=raw,value=latest-debug

    - name: Docker meta (client)
      id: meta-client
      uses: docker/metadata-action@v5
      with:
        images: ${{ secrets.DOCKERHUB_USERNAME }}/edgelink-client
        tags: |
          type=raw,value=latest-debug

    - name: Build and push controller
      uses: docker/build-push-action@v5
      with:
        context: docker
        file: docker/Dockerfile.controller
        push: true
        tags: ${{ steps.meta-controller.outputs.tags }}
        labels: ${{ steps.meta-controller.outputs.labels }}

    - name: Build and push client
      uses: docker/build-push-action@v5
      with:
        context: docker
        file: docker/Dockerfile.client
        push: true
        tags: ${{ steps.meta-client.outputs.tags }}
        labels: ${{ steps.meta-client.outputs.labels }}

  # =============================================================================
  # Release Job
  # =============================================================================
  release:
    needs: [build-linux-release, build-linux-debug, build-windows-release, build-windows-debug, docker-release, docker-debug]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    permissions:
      contents: write

    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          artifacts/edgelink-linux-x64-release/edgelink-linux-x64-release.tar.gz
          artifacts/edgelink-linux-x64-debug/edgelink-linux-x64-debug.tar.gz
          artifacts/edgelink-windows-x64-release/edgelink-windows-x64-release.zip
          artifacts/edgelink-windows-x64-debug/edgelink-windows-x64-debug.zip
        draft: false
        prerelease: ${{ contains(github.ref, '-rc') || contains(github.ref, '-beta') || contains(github.ref, '-alpha') }}
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # =============================================================================
  # Autobuild Release - 每次推送到 main 更新
  # =============================================================================
  autobuild-release:
    needs: [build-linux-release, build-linux-debug, build-windows-release, build-windows-debug]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    permissions:
      contents: write

    steps:
    - uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Prepare release files
      run: |
        mkdir -p release
        # 解压 Linux 包
        tar -xzvf artifacts/edgelink-linux-x64-release/edgelink-linux-x64-release.tar.gz -C release
        mv release/linux/edgelink-client release/edgelink-client-linux-amd64-release
        mv release/linux/edgelink-controller release/edgelink-controller-linux-amd64-release
        rm -rf release/linux

        tar -xzvf artifacts/edgelink-linux-x64-debug/edgelink-linux-x64-debug.tar.gz -C release
        mv release/linux/edgelink-client release/edgelink-client-linux-amd64-debug
        mv release/linux/edgelink-controller release/edgelink-controller-linux-amd64-debug
        rm -rf release/linux

        # 复制 Windows 包
        cp artifacts/edgelink-windows-x64-release/edgelink-windows-x64-release.zip release/
        cp artifacts/edgelink-windows-x64-debug/edgelink-windows-x64-debug.zip release/

        # 创建版本信息
        echo "commit: $(git rev-parse --short HEAD)" > release/version.txt
        echo "build_time: $(date -u +%Y-%m-%d_%H:%M:%S_UTC)" >> release/version.txt

        ls -la release/

    - name: Delete existing autobuild release
      uses: dev-drprasad/delete-tag-and-release@v1.1
      with:
        tag_name: autobuild
        github_token: ${{ secrets.GITHUB_TOKEN }}
        delete_release: true
      continue-on-error: true

    - name: Create autobuild release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: autobuild
        name: Autobuild (Latest)
        body: |
          ## 自动构建版本

          每次推送到 main 分支时自动更新。

          ### Linux 二进制文件
          | 文件 | 说明 |
          |------|------|
          | `edgelink-client-linux-amd64-release` | 客户端 (Release 优化版) |
          | `edgelink-client-linux-amd64-debug` | 客户端 (Debug 调试版) |
          | `edgelink-controller-linux-amd64-release` | 控制器 (Release 优化版) |
          | `edgelink-controller-linux-amd64-debug` | 控制器 (Debug 调试版) |

          ### Windows 打包文件
          | 文件 | 说明 |
          |------|------|
          | `edgelink-windows-x64-release.zip` | Windows Release 版 |
          | `edgelink-windows-x64-debug.zip` | Windows Debug 版 |

          ### 一键安装 (Linux)
          ```bash
          # 安装 Release 版本（默认）
          curl -fsSL https://raw.githubusercontent.com/${{ github.repository }}/main/scripts/install.sh | bash

          # 安装 Debug 版本
          curl -fsSL https://raw.githubusercontent.com/${{ github.repository }}/main/scripts/install.sh | bash -s -- --debug

          # 仅安装客户端
          curl -fsSL https://raw.githubusercontent.com/${{ github.repository }}/main/scripts/install.sh | bash -s -- --client-only

          # 仅安装控制器
          curl -fsSL https://raw.githubusercontent.com/${{ github.repository }}/main/scripts/install.sh | bash -s -- --controller-only
          ```

          ### 版本信息
          - Commit: `${{ github.sha }}`
          - 构建时间: $(date -u +%Y-%m-%d\ %H:%M:%S\ UTC)
        prerelease: true
        files: |
          release/edgelink-client-linux-amd64-release
          release/edgelink-client-linux-amd64-debug
          release/edgelink-controller-linux-amd64-release
          release/edgelink-controller-linux-amd64-debug
          release/edgelink-windows-x64-release.zip
          release/edgelink-windows-x64-debug.zip
          release/version.txt

  # =============================================================================
  # Cleanup Old Workflow Runs
  # =============================================================================
  cleanup:
    runs-on: ubuntu-latest
    if: github.event_name == 'push'

    permissions:
      actions: write

    steps:
    - name: Delete failed/cancelled/skipped runs
      uses: Mattraks/delete-workflow-runs@v2
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        repository: ${{ github.repository }}
        retain_days: 0
        keep_minimum_runs: 0
        delete_run_by_conclusion_pattern: "failure,cancelled,skipped"

    - name: Keep only 3 successful runs
      uses: Mattraks/delete-workflow-runs@v2
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        repository: ${{ github.repository }}
        retain_days: 0
        keep_minimum_runs: 3
        delete_run_by_conclusion_pattern: "success"
