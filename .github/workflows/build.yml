name: Build EdgeLink

on:
  push:
    branches: [ main, master, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  BUILD_TYPE: Release

jobs:
  # =============================================================================
  # Linux Build - All Components (Static)
  # =============================================================================
  build-linux:
    runs-on: ubuntu-24.04
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          ninja-build \
          libboost-all-dev \
          libssl-dev \
          libsqlite3-dev \
          libspdlog-dev \
          nlohmann-json3-dev \
          libsodium-dev \
          libgtest-dev \
          pkg-config

    - name: Configure CMake (Static)
      run: |
        cmake -B build -G Ninja \
          -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}} \
          -DCMAKE_EXE_LINKER_FLAGS="-static-libgcc -static-libstdc++" \
          -DBUILD_SHARED_LIBS=OFF \
          -DBUILD_CONTROLLER=ON \
          -DBUILD_SERVER=ON \
          -DBUILD_CLIENT=ON \
          -DBUILD_TESTS=ON

    - name: Build
      run: cmake --build build --config ${{env.BUILD_TYPE}} -j $(nproc)

    - name: Run Tests
      working-directory: build
      run: ctest -C ${{env.BUILD_TYPE}} --output-on-failure || true

    - name: Strip Binaries
      run: |
        strip build/edgelink-controller || true
        strip build/edgelink-server || true
        strip build/edgelink-client || true

    - name: Package Linux Artifacts
      run: |
        mkdir -p artifacts/linux
        cp build/edgelink-controller artifacts/linux/ || true
        cp build/edgelink-server artifacts/linux/ || true
        cp build/edgelink-client artifacts/linux/ || true
        cp -r config artifacts/linux/
        tar -czvf edgelink-linux-x64.tar.gz -C artifacts linux

    - name: Upload Linux Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: edgelink-linux-x64
        path: edgelink-linux-x64.tar.gz
        retention-days: 30

  # =============================================================================
  # Windows Build - Client Only (Static with wintun)
  # =============================================================================
  build-windows:
    runs-on: windows-latest
    
    env:
      VCPKG_DEFAULT_TRIPLET: x64-windows-static
      VCPKG_BINARY_SOURCES: "clear;x-gha,readwrite"
    
    steps:
    - uses: actions/checkout@v4

    - name: Export GitHub Actions cache environment variables
      uses: actions/github-script@v7
      with:
        script: |
          core.exportVariable('ACTIONS_CACHE_URL', process.env.ACTIONS_CACHE_URL || '');
          core.exportVariable('ACTIONS_RUNTIME_TOKEN', process.env.ACTIONS_RUNTIME_TOKEN || '');

    - name: Setup vcpkg
      uses: lukka/run-vcpkg@v11
      with:
        vcpkgGitCommitId: '01f602195983451bc83e72f4214af2cbc495aa94'
        vcpkgJsonGlob: 'vcpkg.json'

    - name: Download wintun
      run: |
        Invoke-WebRequest -Uri "https://www.wintun.net/builds/wintun-0.14.1.zip" -OutFile "wintun.zip"
        Expand-Archive -Path "wintun.zip" -DestinationPath "wintun"
        mkdir -p third_party/wintun
        Copy-Item -Path "wintun/wintun/include/*" -Destination "third_party/wintun/" -Recurse
        Copy-Item -Path "wintun/wintun/bin/amd64/wintun.dll" -Destination "third_party/wintun/"

    - name: Configure CMake (Windows Client Static)
      run: |
        cmake -B build -G "Visual Studio 17 2022" -A x64 `
          -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}} `
          -DCMAKE_TOOLCHAIN_FILE="${env:VCPKG_ROOT}/scripts/buildsystems/vcpkg.cmake" `
          -DVCPKG_TARGET_TRIPLET=x64-windows-static `
          -DCMAKE_MSVC_RUNTIME_LIBRARY=MultiThreaded `
          -DBUILD_SHARED_LIBS=OFF `
          -DBUILD_CONTROLLER=OFF `
          -DBUILD_SERVER=OFF `
          -DBUILD_CLIENT=ON `
          -DBUILD_TESTS=OFF

    - name: Build
      run: cmake --build build --config ${{env.BUILD_TYPE}} -j $env:NUMBER_OF_PROCESSORS

    - name: Package Windows Artifacts
      run: |
        mkdir -p artifacts/windows
        Copy-Item -Path "build/${{env.BUILD_TYPE}}/edgelink-client.exe" -Destination "artifacts/windows/" -ErrorAction SilentlyContinue
        Copy-Item -Path "third_party/wintun/wintun.dll" -Destination "artifacts/windows/"
        Copy-Item -Path "config" -Destination "artifacts/windows/" -Recurse
        Compress-Archive -Path "artifacts/windows/*" -DestinationPath "edgelink-windows-x64.zip"

    - name: Upload Windows Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: edgelink-windows-x64
        path: edgelink-windows-x64.zip
        retention-days: 30

  # =============================================================================
  # Docker Build & Push to Docker Hub
  # =============================================================================
  build-docker:
    runs-on: ubuntu-24.04
    
    steps:
    - uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Docker meta (Controller)
      id: meta-controller
      uses: docker/metadata-action@v5
      with:
        images: ${{ secrets.DOCKERHUB_USERNAME }}/edgelink-controller
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=sha,prefix=
          type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' }}

    - name: Docker meta (Server)
      id: meta-server
      uses: docker/metadata-action@v5
      with:
        images: ${{ secrets.DOCKERHUB_USERNAME }}/edgelink-server
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=sha,prefix=
          type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' }}

    - name: Docker meta (Client)
      id: meta-client
      uses: docker/metadata-action@v5
      with:
        images: ${{ secrets.DOCKERHUB_USERNAME }}/edgelink-client
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=sha,prefix=
          type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' }}

    - name: Build and push Controller
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        target: controller
        push: true
        tags: ${{ steps.meta-controller.outputs.tags }}
        labels: ${{ steps.meta-controller.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Build and push Server
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        target: server
        push: true
        tags: ${{ steps.meta-server.outputs.tags }}
        labels: ${{ steps.meta-server.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Build and push Client
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        target: client
        push: true
        tags: ${{ steps.meta-client.outputs.tags }}
        labels: ${{ steps.meta-client.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

  # =============================================================================
  # Release Job
  # =============================================================================
  release:
    needs: [build-linux, build-windows, build-docker]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    permissions:
      contents: write
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          artifacts/edgelink-linux-x64/edgelink-linux-x64.tar.gz
          artifacts/edgelink-windows-x64/edgelink-windows-x64.zip
        draft: false
        prerelease: ${{ contains(github.ref, '-rc') || contains(github.ref, '-beta') || contains(github.ref, '-alpha') }}
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
