syntax = "proto3";

package edgelink;

option cc_enable_arenas = true;

// ============================================================================
// Common Types
// ============================================================================

enum ErrorCode {
    ERRCODE_SUCCESS = 0;
    ERRCODE_INVALID_ARGUMENT = 1;
    ERRCODE_SYSTEM = 2;
    ERRCODE_NOT_CONNECTED = 3;
    ERRCODE_DISCONNECTED = 4;
    ERRCODE_TIMEOUT = 5;

    // Authentication errors (1xxx)
    ERRCODE_INVALID_TOKEN = 1001;
    ERRCODE_TOKEN_EXPIRED = 1002;
    ERRCODE_TOKEN_REVOKED = 1003;
    ERRCODE_INVALID_MACHINE_KEY = 1004;
    ERRCODE_SIGNATURE_FAILED = 1005;
    ERRCODE_NODE_UNAUTHORIZED = 1006;
    ERRCODE_AUTH_FAILED = 1007;
    ERRCODE_NOT_AUTHORIZED = 1008;
    ERRCODE_MAX_RETRIES = 1009;

    // Protocol errors (2xxx)
    ERRCODE_UNSUPPORTED_VERSION = 2001;
    ERRCODE_INVALID_MESSAGE = 2002;
    ERRCODE_MESSAGE_TOO_LARGE = 2003;
    ERRCODE_INVALID_FRAME = 2004;

    // Routing errors (3xxx)
    ERRCODE_NODE_NOT_FOUND = 3001;
    ERRCODE_NODE_OFFLINE = 3002;
    ERRCODE_NO_ROUTE = 3003;
    ERRCODE_PEER_NOT_FOUND = 3004;
    ERRCODE_NO_RELAY = 3005;

    // Server errors (4xxx)
    ERRCODE_INTERNAL = 4001;
    ERRCODE_SERVICE_UNAVAILABLE = 4002;
    ERRCODE_OVERLOADED = 4003;

    // Crypto errors (5xxx)
    ERRCODE_CRYPTO = 5001;
    ERRCODE_REPLAY_DETECTED = 5002;
    ERRCODE_KEY_EXCHANGE_FAILED = 5003;
    ERRCODE_INVALID_KEY = 5004;
}

enum NATType {
    NAT_UNKNOWN = 0;
    NAT_OPEN = 1;
    NAT_FULL_CONE = 2;
    NAT_RESTRICTED_CONE = 3;
    NAT_PORT_RESTRICTED = 4;
    NAT_SYMMETRIC = 5;
}

enum EndpointType {
    ENDPOINT_UNKNOWN = 0;
    ENDPOINT_LAN = 1;
    ENDPOINT_STUN = 2;
    ENDPOINT_UPNP = 3;
    ENDPOINT_RELAY = 4;
}

enum UpdateAction {
    ACTION_UNKNOWN = 0;
    ACTION_ADD = 1;
    ACTION_UPDATE = 2;
    ACTION_REMOVE = 3;
}

message Endpoint {
    EndpointType type = 1;
    string ip = 2;
    uint32 port = 3;
    uint32 priority = 4;
}

message Error {
    ErrorCode code = 1;
    string message = 2;
    string details = 3;
}

// ============================================================================
// Authentication Messages
// ============================================================================

message AuthRequest {
    string machine_key_pub = 1;     // Base64 encoded Ed25519 public key
    string node_key_pub = 2;        // Base64 encoded X25519 public key
    string hostname = 3;
    string os = 4;
    string arch = 5;
    string version = 6;
    string signature = 7;           // Ed25519 signature
    uint64 timestamp = 8;
    string auth_key = 9;            // Pre-shared key for auto-registration
}

message AuthResponse {
    bool success = 1;
    uint32 node_id = 2;
    string virtual_ip = 3;
    string auth_token = 4;          // JWT auth token
    string relay_token = 5;         // JWT relay token
    string error_message = 6;
}

// ============================================================================
// Configuration Messages
// ============================================================================

message RelayInfo {
    uint32 server_id = 1;
    string name = 2;
    string url = 3;
    string region = 4;
}

message STUNInfo {
    uint32 server_id = 1;
    string name = 2;
    string ip = 3;
    uint32 port = 4;
    string secondary_ip = 5;
}

message PeerInfo {
    uint32 node_id = 1;
    string name = 2;
    string virtual_ip = 3;
    string node_key_pub = 4;        // Base64 encoded X25519 public key
    bool online = 5;
    repeated Endpoint endpoints = 6;
}

message RouteInfo {
    string cidr = 1;
    uint32 gateway_node_id = 2;
    uint32 priority = 3;
    uint32 weight = 4;
    bool enabled = 5;
}

message Config {
    uint64 version = 1;
    uint32 network_id = 2;
    string network_name = 3;
    string subnet = 4;
    repeated RelayInfo relays = 5;
    repeated STUNInfo stun_servers = 6;
    repeated PeerInfo peers = 7;
    repeated RouteInfo routes = 8;
    string new_relay_token = 9;
    int64 relay_token_expires_at = 10;
}

// Config updates
message PeerUpdate {
    UpdateAction action = 1;
    PeerInfo peer = 2;
}

message RouteUpdate {
    UpdateAction action = 1;
    RouteInfo route = 2;
}

message ServerUpdate {
    UpdateAction action = 1;
    oneof server {
        RelayInfo relay = 2;
        STUNInfo stun = 3;
    }
}

message ConfigUpdate {
    uint64 version = 1;
    repeated PeerUpdate peer_updates = 2;
    repeated RouteUpdate route_updates = 3;
    repeated ServerUpdate server_updates = 4;
    optional string new_relay_token = 5;
    optional int64 relay_token_expires_at = 6;
    optional IPChange ip_change = 7;
}

// IP address change notification from controller
message IPChange {
    string old_ip = 1;
    string new_ip = 2;
    string reason = 3;  // e.g., "admin_change", "conflict_resolution", "network_migration"
}

// ============================================================================
// Data Messages
// ============================================================================

message DataPacket {
    uint32 src_node_id = 1;
    uint32 dst_node_id = 2;
    bytes nonce = 3;                // 12 bytes
    bytes encrypted_data = 4;       // Includes auth tag
}

// ============================================================================
// Heartbeat Messages
// ============================================================================

message Ping {
    uint64 timestamp = 1;
}

message Pong {
    uint64 timestamp = 1;
}

message LatencyEntry {
    string dst_type = 1;            // "relay" or "node"
    uint32 dst_id = 2;
    uint32 rtt_ms = 3;
}

message LatencyReport {
    repeated LatencyEntry entries = 1;
}

// ============================================================================
// P2P Messages
// ============================================================================

message P2PInit {
    uint32 peer_node_id = 1;
}

message P2PEndpoint {
    uint32 peer_node_id = 1;
    repeated Endpoint endpoints = 2;
    NATType nat_type = 3;
}

message P2PPing {
    uint32 peer_node_id = 1;
    uint64 timestamp = 2;
    bytes nonce = 3;
}

message P2PPong {
    uint32 peer_node_id = 1;
    uint64 timestamp = 2;
    bytes nonce = 3;
}

message P2PKeepalive {
    uint32 peer_node_id = 1;
}

message P2PStatus {
    uint32 peer_node_id = 1;
    bool connected = 2;
    string endpoint_ip = 3;
    uint32 endpoint_port = 4;
    uint32 rtt_ms = 5;
}

// ============================================================================
// Server Messages
// ============================================================================

message ServerRegister {
    string server_token = 1;
    string name = 2;
    uint32 capabilities = 3;        // ServerCapability flags
    string region = 4;
    string relay_url = 5;
    string stun_ip = 6;
    uint32 stun_port = 7;
    string stun_ip2 = 8;
}

message ServerRegisterResponse {
    bool success = 1;
    uint32 server_id = 2;
    string error_message = 3;
}

message NodeLocation {
    uint32 node_id = 1;
    repeated uint32 connected_relay_ids = 2;
}

message ServerNodeLoc {
    repeated NodeLocation nodes = 1;
}

message BlacklistEntry {
    string jti = 1;
    int64 expires_at = 2;
}

message ServerBlacklist {
    bool full_sync = 1;
    repeated BlacklistEntry entries = 2;
}

message ServerHeartbeat {
    uint32 server_id = 1;
    uint64 timestamp = 2;
    uint32 connected_clients = 3;
}

message ServerLatency {
    uint32 server_id = 1;
    uint32 target_server_id = 2;
    uint32 rtt_ms = 3;
}

message ServerRelayList {
    repeated RelayInfo relays = 1;
}

message MeshLatencyEntry {
    uint32 target_server_id = 1;
    uint32 rtt_ms = 2;
}

message ServerLatencyReport {
    uint32 server_id = 1;
    repeated MeshLatencyEntry entries = 2;
}

// ============================================================================
// Relay Messages
// ============================================================================

message RelayAuth {
    string relay_token = 1;
}

message RelayAuthResponse {
    bool success = 1;
    uint32 node_id = 2;
    string error_message = 3;
}

// ============================================================================
// Mesh Messages (Relay-to-Relay)
// ============================================================================

message MeshHello {
    uint32 server_id = 1;
    string server_token = 2;
}

message MeshHelloAck {
    bool success = 1;
    uint32 server_id = 2;
    string error_message = 3;
}

message MeshForward {
    uint32 src_server_id = 1;
    uint32 dst_server_id = 2;
    DataPacket data = 3;
}

message MeshPing {
    uint32 server_id = 1;
    uint64 timestamp = 2;
}

message MeshPong {
    uint32 server_id = 1;
    uint64 timestamp = 2;
}

// ============================================================================
// Control Service (Client <-> Controller)
// ============================================================================

// Bidirectional streaming for control channel
message ControlMessage {
    oneof message {
        // Client -> Controller
        AuthRequest auth_request = 1;
        LatencyReport latency_report = 2;
        P2PInit p2p_init = 3;
        P2PStatus p2p_status = 4;
        Ping ping = 5;

        // Controller -> Client
        AuthResponse auth_response = 10;
        Config config = 11;
        ConfigUpdate config_update = 12;
        P2PEndpoint p2p_endpoint = 13;
        Pong pong = 14;
        Error error = 15;
    }
}

service ControlService {
    // Bidirectional streaming for real-time control channel
    rpc Control(stream ControlMessage) returns (stream ControlMessage);
}

// ============================================================================
// Server Service (Server <-> Controller)
// ============================================================================

message ServerMessage {
    oneof message {
        // Server -> Controller
        ServerRegister server_register = 1;
        ServerHeartbeat server_heartbeat = 2;
        ServerLatencyReport server_latency_report = 3;
        Ping ping = 4;

        // Controller -> Server
        ServerRegisterResponse server_register_response = 10;
        ServerNodeLoc server_node_loc = 11;
        ServerBlacklist server_blacklist = 12;
        ServerRelayList server_relay_list = 13;
        Pong pong = 14;
        Error error = 15;
    }
}

service ServerService {
    // Bidirectional streaming for server-controller communication
    rpc ServerChannel(stream ServerMessage) returns (stream ServerMessage);
}

// ============================================================================
// Relay Service (Client <-> Relay)
// ============================================================================

message RelayMessage {
    oneof message {
        // Client -> Relay
        RelayAuth relay_auth = 1;
        DataPacket data = 2;
        Ping ping = 3;

        // Relay -> Client
        RelayAuthResponse relay_auth_response = 10;
        DataPacket relay_data = 11;
        Pong pong = 12;
        Error error = 13;
    }
}

service RelayService {
    // Bidirectional streaming for data relay
    rpc Relay(stream RelayMessage) returns (stream RelayMessage);
}

// ============================================================================
// Mesh Service (Relay <-> Relay)
// ============================================================================

message MeshMessage {
    oneof message {
        MeshHello mesh_hello = 1;
        MeshHelloAck mesh_hello_ack = 2;
        MeshForward mesh_forward = 3;
        MeshPing mesh_ping = 4;
        MeshPong mesh_pong = 5;
        Error error = 6;
    }
}

service MeshService {
    // Bidirectional streaming for mesh network
    rpc Mesh(stream MeshMessage) returns (stream MeshMessage);
}

// ============================================================================
// IPC Service (CLI <-> Client daemon via Unix socket)
// ============================================================================

message IPCStatusRequest {}

message IPCStatusResponse {
    bool connected = 1;
    string state = 2;               // "stopped", "connecting", "running", etc.
    uint32 node_id = 3;
    string virtual_ip = 4;
    string controller_url = 5;
    string tun_interface = 6;

    // Stats
    uint64 packets_sent = 10;
    uint64 packets_received = 11;
    uint64 bytes_sent = 12;
    uint64 bytes_received = 13;
    int64 uptime_seconds = 14;

    // Peers
    repeated IPCPeerInfo peers = 20;

    // Relays
    repeated IPCRelayInfo relays = 21;
}

message IPCPeerInfo {
    uint32 node_id = 1;
    string name = 2;
    string virtual_ip = 3;
    bool online = 4;
    bool p2p_connected = 5;
    uint32 latency_ms = 6;
    string connection_type = 7;     // "p2p", "relay", "none"
}

message IPCRelayInfo {
    uint32 server_id = 1;
    string name = 2;
    string region = 3;
    bool connected = 4;
    uint32 latency_ms = 5;
}

message IPCDisconnectRequest {}
message IPCDisconnectResponse {
    bool success = 1;
    string message = 2;
}

message IPCReconnectRequest {}
message IPCReconnectResponse {
    bool success = 1;
    string message = 2;
}

message IPCPingRequest {
    uint32 peer_node_id = 1;        // 0 = ping controller
}
message IPCPingResponse {
    bool success = 1;
    uint32 latency_ms = 2;
    string error = 3;
}

// IPC message wrapper
message IPCMessage {
    oneof message {
        // Requests (CLI -> Client)
        IPCStatusRequest status_request = 1;
        IPCDisconnectRequest disconnect_request = 2;
        IPCReconnectRequest reconnect_request = 3;
        IPCPingRequest ping_request = 4;

        // Responses (Client -> CLI)
        IPCStatusResponse status_response = 10;
        IPCDisconnectResponse disconnect_response = 11;
        IPCReconnectResponse reconnect_response = 12;
        IPCPingResponse ping_response = 13;
        Error error = 14;
    }
}

// IPC Service (for local Unix socket communication)
service IPCService {
    rpc Status(IPCStatusRequest) returns (IPCStatusResponse);
    rpc Disconnect(IPCDisconnectRequest) returns (IPCDisconnectResponse);
    rpc Reconnect(IPCReconnectRequest) returns (IPCReconnectResponse);
    rpc Ping(IPCPingRequest) returns (IPCPingResponse);
}

// ============================================================================
// Admin Service (Management API - replaces HTTP REST API)
// ============================================================================

// Health & Version
message HealthRequest {}
message HealthResponse {
    bool healthy = 1;
    string version = 2;
    uint32 protocol_version = 3;
}

// Network Management
message Network {
    uint32 id = 1;
    string name = 2;
    string subnet = 3;
    string description = 4;
    int64 created_at = 5;
}

message ListNetworksRequest {}
message ListNetworksResponse {
    repeated Network networks = 1;
}

message CreateNetworkRequest {
    string name = 1;
    string subnet = 2;
    string description = 3;
}
message CreateNetworkResponse {
    bool success = 1;
    uint32 network_id = 2;
    string error = 3;
}

message DeleteNetworkRequest {
    uint32 network_id = 1;
}
message DeleteNetworkResponse {
    bool success = 1;
    string error = 2;
}

// Node Management
message NodeInfo {
    uint32 id = 1;
    uint32 network_id = 2;
    string name = 3;
    string virtual_ip = 4;
    string hostname = 5;
    string os = 6;
    string arch = 7;
    string version = 8;
    NATType nat_type = 9;
    bool online = 10;
    bool authorized = 11;
    string last_seen = 12;
    string machine_key_pub = 13;
    repeated Endpoint endpoints = 14;
    repeated RouteInfo routes = 15;
}

message ListNodesRequest {
    optional uint32 network_id = 1;  // Filter by network
}
message ListNodesResponse {
    repeated NodeInfo nodes = 1;
}

message GetNodeRequest {
    uint32 node_id = 1;
}
message GetNodeResponse {
    bool found = 1;
    NodeInfo node = 2;
}

message AuthorizeNodeRequest {
    uint32 node_id = 1;
}
message AuthorizeNodeResponse {
    bool success = 1;
    string error = 2;
}

message DeauthorizeNodeRequest {
    uint32 node_id = 1;
}
message DeauthorizeNodeResponse {
    bool success = 1;
    string error = 2;
}

message DeleteNodeRequest {
    uint32 node_id = 1;
}
message DeleteNodeResponse {
    bool success = 1;
    string error = 2;
}

message UpdateNodeIPRequest {
    uint32 node_id = 1;
    string new_virtual_ip = 2;
    string reason = 3;
}
message UpdateNodeIPResponse {
    bool success = 1;
    string old_ip = 2;
    string new_ip = 3;
    string error = 4;
}

// Server (Relay) Management
message ServerInfo {
    uint32 id = 1;
    string name = 2;
    string type = 3;                // "relay", "stun"
    string url = 4;
    string region = 5;
    uint32 capabilities = 6;
    string stun_ip = 7;
    string stun_ip2 = 8;
    uint32 stun_port = 9;
    bool enabled = 10;
    string last_heartbeat = 11;
    uint32 connected_clients = 12;
}

message ListServersRequest {}
message ListServersResponse {
    repeated ServerInfo servers = 1;
}

message RegisterServerRequest {
    string name = 1;
    string type = 2;
    string url = 3;
    string region = 4;
    uint32 capabilities = 5;
    string stun_ip = 6;
    string stun_ip2 = 7;
    uint32 stun_port = 8;
}
message RegisterServerResponse {
    bool success = 1;
    uint32 server_id = 2;
    string server_token = 3;
    string error = 4;
}

message DeleteServerRequest {
    uint32 server_id = 1;
}
message DeleteServerResponse {
    bool success = 1;
    string error = 2;
}

// Statistics
message StatsRequest {}
message StatsResponse {
    uint32 nodes_online = 1;
    uint32 nodes_total = 2;
    uint32 servers_online = 3;
    uint32 servers_total = 4;
    uint32 networks_total = 5;
    uint64 total_bytes_relayed = 6;
}

// Admin Service
service AdminService {
    // Health & Version
    rpc Health(HealthRequest) returns (HealthResponse);

    // Network Management
    rpc ListNetworks(ListNetworksRequest) returns (ListNetworksResponse);
    rpc CreateNetwork(CreateNetworkRequest) returns (CreateNetworkResponse);
    rpc DeleteNetwork(DeleteNetworkRequest) returns (DeleteNetworkResponse);

    // Node Management
    rpc ListNodes(ListNodesRequest) returns (ListNodesResponse);
    rpc GetNode(GetNodeRequest) returns (GetNodeResponse);
    rpc AuthorizeNode(AuthorizeNodeRequest) returns (AuthorizeNodeResponse);
    rpc DeauthorizeNode(DeauthorizeNodeRequest) returns (DeauthorizeNodeResponse);
    rpc DeleteNode(DeleteNodeRequest) returns (DeleteNodeResponse);
    rpc UpdateNodeIP(UpdateNodeIPRequest) returns (UpdateNodeIPResponse);

    // Server Management
    rpc ListServers(ListServersRequest) returns (ListServersResponse);
    rpc RegisterServer(RegisterServerRequest) returns (RegisterServerResponse);
    rpc DeleteServer(DeleteServerRequest) returns (DeleteServerResponse);

    // Statistics
    rpc GetStats(StatsRequest) returns (StatsResponse);
}
