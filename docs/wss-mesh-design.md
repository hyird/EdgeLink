# WSS-Mesh 设计文档

---

## 1. 功能清单

### 1.1 核心功能

| 模块 | 功能 | 说明 | 状态 |
|------|------|------|------|
| **组网** | 虚拟私有网络 | 基于 TUN 设备的 Layer 3 VPN | ✅ |
| | 多网络隔离 | 支持创建多个独立的虚拟网络 | ✅ |
| | 自动 IP 分配 | Controller 自动分配虚拟 IP | ✅ |
| **连接** | WSS Relay 中继 | 通过 WebSocket Secure 中继数据 | ✅ |
| | P2P 直连 | UDP 打洞实现点对点直连 | ✅ |
| | Relay Mesh | 多 Relay 服务器全网状互联 | ✅ |
| | 多 Relay 连接 | 客户端同时连接所有 Relay | ✅ |
| **安全** | 端到端加密 | X25519 + ChaCha20-Poly1305 | ✅ |
| | 身份认证 | Ed25519 machine_key 身份绑定 | ✅ |
| | JWT Token | 多种 Token 类型，分级权限 | ✅ |
| | 前向保密 | node_key 定期轮换 (24h) | ✅ |
| | 重放攻击防护 | Nonce + 滑动窗口 | ✅ |
| **路由** | 子网宣告 | 节点可宣告本地子网 | ✅ |
| | 优先级/权重 | 多网关负载均衡 | ✅ |
| | 故障转移 | 网关离线自动切换 | ✅ |
| | 最长前缀匹配 | 路由查找算法 | ✅ |
| **延迟优化** | 延迟测量 | Node→Relay, Relay→Relay RTT | ✅ |
| | 最优路径计算 | 基于延迟的路径选择 | ✅ |
| | 动态路径切换 | 延迟变化时自动切换 | ✅ |

### 1.2 组件功能

#### Controller (控制器)

| 功能 | 说明 | 状态 |
|------|------|------|
| REST API | 节点/网络/路由/服务器管理 | ✅ |
| WebSocket 控制通道 | /ws/control 客户端连接 | ✅ |
| WebSocket 服务器通道 | /ws/server Relay/STUN 连接 | ✅ |
| 节点认证 | machine_key 验证，Token 签发 | ✅ |
| 配置下发 | peers, relays, routes 推送 | ✅ |
| 延迟数据收集 | 聚合节点上报的延迟数据 | ✅ |
| 路径计算服务 | 计算最优转发路径 | ✅ |
| 节点位置同步 | 广播 node→relay 映射 | ✅ |
| Token 黑名单 | 撤销失效 Token | ✅ |
| 内置 Relay | 可选，小规模部署 | ✅ |
| 内置 STUN | 可选，需公网 IP | ✅ |
| 数据库支持 | SQLite / MariaDB | ✅ |

#### Server (Relay/STUN 独立部署)

| 功能 | 说明 | 状态 |
|------|------|------|
| Relay WSS 服务 | /ws/data 客户端数据通道 | ✅ |
| Relay Mesh 互联 | /ws/mesh Relay 间数据通道 | ✅ |
| STUN 服务 | UDP 3478 NAT 探测 | ✅ |
| NAT 类型检测 | 双 IP 完整检测 | ✅ |
| JWT 本地验证 | 共享密钥验证 Token | ✅ |
| 节点位置缓存 | node_id → relay_id 映射 | ✅ |
| 延迟测量 | Relay 间 PING/PONG | ✅ |
| Controller 连接 | 控制平面通信 | ✅ |

#### Client (客户端)

| 功能 | 说明 | 状态 |
|------|------|------|
| TUN 设备 | 虚拟网卡，IP 包收发 | ✅ |
| 控制通道 | 连接 Controller，接收配置 | ✅ |
| 多 Relay 连接 | 同时连接所有可用 Relay | ✅ |
| P2P 管理 | STUN 探测，UDP 打洞 | ✅ |
| 端点收集 | LAN/STUN/UPnP 端点 | ✅ |
| 加密引擎 | 端到端加密/解密 | ✅ |
| 路由管理 | 子网路由，优先级选择 | ✅ |
| 延迟上报 | 定期上报到各 Relay 的延迟 | ✅ |
| 密钥轮换 | node_key 定期更新 | ✅ |
| NAT Keepalive | P2P 连接保活 | ✅ |

### 1.3 连接模式

```
优先级从高到低:

1. LAN Direct       - 局域网直连 (同一子网)
2. P2P Direct       - UDP NAT 穿透直连 (STUN 打洞成功)
3. Relay (单跳)     - 同一 Relay 服务器转发
4. Relay Mesh (多跳) - 跨 Relay 服务器转发
```

### 1.4 部署规模

| 规模 | 节点数 | 推荐部署 |
|------|--------|----------|
| 小规模 | < 50 | Controller × 1 (内置 Relay + STUN) |
| 中规模 | 50-500 | Controller × 1 + Relay/STUN × 2-3 |
| 大规模 | > 500 | Controller (HA) + Relay × N (CDN) + STUN × 2-3 |

### 1.5 协议与安全

| 类别 | 技术选型 |
|------|----------|
| 传输层 | WebSocket Secure (WSS) over TLS 1.3 |
| 密钥交换 | X25519 ECDH |
| 对称加密 | ChaCha20-Poly1305 (AEAD) |
| 密钥派生 | HKDF-SHA256 |
| 身份签名 | Ed25519 |
| Token | JWT (HS256 / RS256) |
| NAT 穿透 | STUN (RFC 5389) |

### 1.6 CLI 管理工具 (edgelink-ctl)

所有管理操作通过命令行工具完成：

```bash
edgelink-ctl [options] <command> [subcommand] [args...]

选项:
  --db <path>       数据库路径 (默认: edgelink.db)
  --config <path>   配置文件路径
  -q, --quiet       静默模式
  -h, --help        显示帮助
```

| 命令 | 子命令 | 说明 |
|------|--------|------|
| `network` | list, create, show, delete | 网络管理 |
| `node` | list, show, authorize, deauthorize, rename, delete | 节点管理 |
| `server` | list, add, show, enable, disable, token, delete | 服务器管理 |
| `route` | list, add, enable, disable, delete | 路由管理 |
| `token` | generate, blacklist | Token 管理 |
| `config` | show, set, init | 配置管理 |
| `status` | - | 系统状态概览 |
| `latency` | - | 延迟矩阵 |

常用命令示例：

```bash
# 创建网络
edgelink-ctl -q network create --name main --subnet 10.100.0.0/16

# 列出节点
edgelink-ctl -q node list [--network <id>] [--online]

# 授权节点
edgelink-ctl -q node authorize <id>

# 添加服务器
edgelink-ctl -q server add --name relay-1 --url wss://relay.example.com/ws/data

# 添加路由
edgelink-ctl -q route add --cidr 192.168.1.0/24 --node <id> [--priority 100]

# 查看系统状态
edgelink-ctl -q status
```

---

## 2. 系统架构

### 2.1 组件说明

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              组件部署模式                                        │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  Controller (控制器)                                                            │
│  ├── 必选: 控制平面 (认证、配置下发、管理 API)                                   │
│  ├── 可选: 内置 Relay (小规模部署可启用)                                        │
│  └── 可选: 内置 STUN (需要真实公网 IP)                                          │
│                                                                                 │
│  Relay/STUN Server (独立部署)                                                   │
│  ├── 可选: Relay 功能 (WSS 中继，可穿透 CDN)                                    │
│  └── 可选: STUN 功能 (NAT 探测，必须真实公网 IP，不能用 CDN)                     │
│                                                                                 │
│  部署示例:                                                                       │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │ 小规模 (< 50 节点):                                                      │   │
│  │   Controller (启用内置 Relay + STUN) × 1                                 │   │
│  │                                                                         │   │
│  │ 中规模 (50-500 节点):                                                    │   │
│  │   Controller × 1                                                        │   │
│  │   Relay+STUN Server × 2-3 (不同地区)                                    │   │
│  │                                                                         │   │
│  │ 大规模 (> 500 节点):                                                     │   │
│  │   Controller × 1 (或 HA)                                                │   │
│  │   Relay Server × N (CDN 加速，只启用 Relay)                             │   │
│  │   STUN Server × 2-3 (真实公网 IP，只启用 STUN)                          │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 2.2 整体架构

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              Controller (控制器)                                 │
│                                                                                 │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐            │
│  │ Auth        │  │ Node        │  │ Config      │  │ Latency     │            │
│  │ Service     │  │ Registry    │  │ Manager     │  │ Collector   │            │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘            │
│                                                                                 │
│  ┌─────────────────────────────┐  ┌─────────────────────────────┐              │
│  │ 内置 Relay (可选)           │  │ 内置 STUN (可选)            │              │
│  │ enable_relay: true/false   │  │ enable_stun: true/false    │              │
│  └─────────────────────────────┘  └─────────────────────────────┘              │
│                                                                                 │
│                         ┌─────────────────────────┐                            │
│                         │  MariaDB / SQLite       │                            │
│                         └─────────────────────────┘                            │
└───────────────────────────────────┬─────────────────────────────────────────────┘
                                    │
                    ┌───────────────┼───────────────┐
                    │               │               │
                    ▼               ▼               ▼
           ┌──────────────┐ ┌──────────────┐ ┌──────────────┐
           │ Relay+STUN   │◄═══ Mesh ════►│ Relay+STUN   │ │ Relay Only   │
           │  Server      │  Interconnect │  Server      │ │ (via CDN)    │ect │  Server      │ │ (via CDN)    │
           │ (Asia)       │               │ (US)         │ │ (EU)         │
           │              │               │              │ └──────────────┘
           │ Relay: WSS   │               │ Relay: WSS   │
           │ STUN: UDP    │               │ STUN: UDP    │
           │ (真实公网IP) │               │ (真实公网IP) │
           └──────┬───────┘               └──────┬───────┘
                  │                              │
        ┌─────────┴──────────────────────────────┴─────────┐
        │                                                   │
        │                      Clients                      │
        │         (注册到所有 Relay，选最优路径)             │
        │                                                   │
   ┌─────────┐  ◄─── P2P Direct ───►  ┌─────────┐    ┌─────────┐
   │ Node A  │                        │ Node B  │    │ Node C  │
   │ 10.0.1.1│                        │10.0.1.2 │    │10.0.1.3 │
   │         │                        │         │    │ Gateway │
   └─────────┘                        └─────────┘    └────┬────┘
                                                          │
                                                   ┌──────┴──────┐
                                                   │ LAN Subnet  │
                                                   │192.168.1.0/24│
                                                   └─────────────┘
```

### 2.3 Relay 与 STUN 的网络要求

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           网络部署要求                                           │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  Relay (WSS 443):                                                               │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │ ✅ 可以使用 CDN (Cloudflare, AWS CloudFront 等)                         │   │
│  │ ✅ 支持 WSS 协议穿透                                                    │   │
│  │ ✅ 可以隐藏源站 IP                                                      │   │
│  │ ✅ 支持多地区 Anycast                                                   │   │
│  │                                                                         │   │
│  │ 部署方式:                                                               │   │
│  │   Client ──WSS──► CDN ──WSS──► Relay Server (源站)                      │   │
│  │                                                                         │   │
│  │ CDN 配置要求:                                                           │   │
│  │   - 启用 WebSocket 支持                                                 │   │
│  │   - 超时时间 >= 60s                                                     │   │
│  │   - 建议启用 TLS 1.3                                                    │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  STUN (UDP 3478):                                                               │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │ ❌ 不能使用 CDN (CDN 不支持 UDP)                                        │   │
│  │ ❌ 不能使用任何代理                                                     │   │
│  │ ✅ 必须绑定真实公网 IP                                                  │   │
│  │ ✅ 需要配置 external_ip (服务器的公网 IP)                               │   │
│  │                                                                         │   │
│  │ 原因:                                                                   │   │
│  │   STUN 协议需要告诉客户端"你的公网 IP:Port 是什么"                      │   │
│  │   如果经过代理，返回的是代理的地址，打洞会失败                           │   │
│  │                                                                         │   │
│  │ 部署方式:                                                               │   │
│  │   Client ──UDP──► STUN Server (公网 IP，无任何中间层)                   │   │
│  │                                                                         │   │
│  │ NAT 类型检测需要两个不同 IP:                                            │   │
│  │   - primary_ip: 主 IP (必须)                                            │   │
│  │   - secondary_ip: 备用 IP (可选，用于完整 NAT 检测)                     │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 2.4 Relay Mesh 组网

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           Relay Mesh 架构                                        │
│                                                                                 │
│                        ┌────────────────────┐                                   │
│                        │    Controller      │                                   │
│                        │ (只负责控制平面)    │                                   │
│                        │ - 路径计算         │                                   │
│                        │ - 节点位置同步     │                                   │
│                        │ - Relay 发现       │                                   │
│                        │ - 不参与数据转发！ │                                   │
│                        └────────┬───────────┘                                   │
│                                 │ Control Plane                                 │
│          ┌──────────────────────┼───────────────────────┐                       │
│          │                      │                       │                       │
│   ┌──────┴─────┐         ┌──────┴─────┐          ┌──────┴─────┐                │
│   │  Relay-1   │◄═══════════════════════════════►│  Relay-2   │                │
│   │  (Asia)    │   WSS Mesh (数据平面直连)       │  (US)      │                │
│   │  via CDN   │◄══════════════╗                 │  via CDN   │                │
│   └─────┬──────┘               ║                 └──────┬─────┘                │
│         │                 ┌────╨────┐                   │                       │
│         │                 │ Relay-3 │                   │                       │
│         │                 │  (EU)   │═══════════════════╝                       │
│         │                 └────┬────┘                                           │
│         │                      │                                                │
│    ┌────┴────┐            ┌────┴────┐            ┌────┴────┐                   │
│    │ Node A  │            │ Node C  │            │ Node B  │                   │
│    │ China   │            │ Germany │            │ US      │                   │
│    └─────────┘            └─────────┘            └─────────┘                   │
│                                                                                 │
│   重要: Controller 不参与数据转发！                                             │
│   - Controller 只负责: 认证、路径计算、配置下发、节点位置信息同步               │
│   - Relay 之间建立全网状 WSS 连接 (Mesh)                                       │
│   - 跨 Relay 数据通过 Relay Mesh 直接转发，不经过 Controller                   │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 2.4.1 控制平面 vs 数据平面

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                      控制平面与数据平面分离                                      │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  控制平面 (Control Plane) - 通过 Controller                                     │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │ ✓ 节点认证 (JWT Token 签发)                                             │   │
│  │ ✓ 配置下发 (Relay 列表、STUN 列表、网络参数)                            │   │
│  │ ✓ 节点位置同步 (哪个节点连在哪个 Relay)                                 │   │
│  │ ✓ 延迟数据收集 (节点→Relay, Relay→Relay)                               │   │
│  │ ✓ 最优路径计算 (基于延迟数据)                                          │   │
│  │ ✓ P2P 端点交换 (STUN 打洞协调)                                         │   │
│  │ ✓ 路由表管理 (子网宣告聚合)                                            │   │
│  │ ✗ 不转发用户数据！                                                     │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  数据平面 (Data Plane) - 通过 Relay Mesh                                        │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │ ✓ 节点 ↔ Relay: WSS 加密数据传输                                       │   │
│  │ ✓ Relay ↔ Relay: WSS Mesh 直接转发                                     │   │
│  │ ✓ 同 Relay 转发: Node A → Relay → Node B                               │   │
│  │ ✓ 跨 Relay 转发: Node A → Relay-1 → Relay-2 → Node B                   │   │
│  │ ✗ 不经过 Controller！                                                  │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  示例数据流 (Node A in China → Node B in US):                                   │
│                                                                                 │
│  ┌────────┐     WSS      ┌──────────┐   WSS Mesh   ┌──────────┐    WSS     ┌────────┐
│  │ Node A │─────────────►│ Relay-1  │═════════════►│ Relay-2  │───────────►│ Node B │
│  │ China  │  data frame  │  (Asia)  │  data frame  │  (US)    │ data frame│  US    │
│  └────────┘              └──────────┘              └──────────┘           └────────┘
│       │                                                                        │
│       │  Controller 只提供路径信息，不参与数据转发                              │
│       │  "Node B 在 Relay-2，Relay-1 到 Relay-2 延迟 50ms"                     │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 2.4.2 Relay Mesh 连接管理

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                       Relay Mesh 连接策略                                        │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  连接建立:                                                                       │
│  1. Relay 启动时连接 Controller，获取其他 Relay 列表                            │
│  2. Relay 与所有其他 Relay 建立 WSS 连接 (/ws/mesh)                             │
│  3. 每个连接维护心跳，断开自动重连                                              │
│                                                                                 │
│  Mesh 连接类型:                                                                  │
│  - Outbound: 主动连接其他 Relay (按 relay_id 较小方发起)                        │
│  - Inbound: 接受其他 Relay 的连接请求                                           │
│  - 避免重复连接: 只保留一条连接 (Outbound 或 Inbound)                           │
│                                                                                 │
│  延迟探测:                                                                       │
│  - Relay 间每 30s 互发 PING/PONG                                                │
│  - 计算 RTT 并上报给 Controller                                                 │
│  - Controller 基于延迟数据计算最优路径                                          │
│                                                                                 │
│  节点位置同步:                                                                   │
│  - Controller 定期广播节点位置变更                                              │
│  - 每个 Relay 维护 node_id → relay_id 映射缓存                                  │
│  - 收到数据包时查询缓存决定转发目标                                             │
│                                                                                 │
│  ┌─────────────┐    /ws/server      ┌────────────┐    /ws/server   ┌─────────────┐
│  │  Relay-1    │◄──────────────────►│ Controller │◄──────────────►│  Relay-2    │
│  │             │   (控制连接)       │            │  (控制连接)    │             │
│  └──────┬──────┘                    └────────────┘                └──────┬──────┘
│         │                                                                │
│         │◄═══════════════════════════════════════════════════════════════╝
│         │                    /ws/mesh (数据Mesh直连)                     
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 2.4.3 节点连接策略

```
节点连接策略:
- 每个节点连接所有可用 Relay (保持 WSS 长连接)
- 定期测量到每个 Relay 的延迟
- 发送数据时选择延迟最低的路径

路径选择示例 (Node A → Node B):
方案1: A → Relay-1 → B          (如果 B 也连着 Relay-1)
方案2: A → Relay-1 → Relay-2 → B (跨 Relay 转发，Relay间直连)
选择: path_latency 最小的路径
```

### 2.5 连接模式优先级

```
优先级从高到低:

1. LAN Direct (UDP/TCP)
   ┌────────┐                      ┌────────┐
   │ Node A │◄─── 局域网直连 ──────►│ Node B │
   └────────┘    192.168.x.x       └────────┘

2. P2P Direct (UDP NAT Traversal)
   ┌────────┐                      ┌────────┐
   │ Node A │◄────── UDP ─────────►│ Node B │
   └────────┘   (STUN 打洞成功)    └────────┘

3. Relay (WSS - 选择最优路径)
   ┌────────┐        ┌────────┐        ┌────────┐
   │ Node A │───────►│ Relay  │◄───────│ Node B │
   └────────┘  WSS   └────────┘  WSS   └────────┘
```

---

## 3. 安全设计

### 3.1 密钥体系

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              密钥层次结构                                        │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                         Controller 层                                    │   │
│  │                                                                         │   │
│  │  JWT_SECRET: Controller 签发 Token 的密钥 (HS256 或 RS256)              │   │
│  │  RELAY_AUTH_KEY: Relay 服务器认证密钥                                   │   │
│  │                                                                         │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                          节点层 (每个节点)                               │   │
│  │                                                                         │   │
│  │  machine_key: Ed25519 密钥对                                            │   │
│  │    - 设备唯一标识，首次启动时生成，永久保存                              │   │
│  │    - 私钥: 本地保存，永不传输                                           │   │
│  │    - 公钥: 注册时提交给 Controller                                      │   │
│  │                                                                         │   │
│  │  node_key: X25519 密钥对                                                │   │
│  │    - 用于端到端加密的密钥协商                                            │   │
│  │    - 可定期轮换 (默认 24 小时)                                           │   │
│  │    - 私钥: 本地保存                                                     │   │
│  │    - 公钥: 通过 Controller 分发给其他节点                                │   │
│  │                                                                         │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                         会话层 (节点对之间)                              │   │
│  │                                                                         │   │
│  │  session_key: 32 字节对称密钥                                           │   │
│  │    - 由双方 node_key 通过 X25519 ECDH 协商得出                          │   │
│  │    - 使用 HKDF-SHA256 派生                                              │   │
│  │    - 每次 node_key 轮换后重新协商                                        │   │
│  │                                                                         │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 端到端加密

```
算法选择:
  - 密钥交换: X25519 ECDH
  - 对称加密: ChaCha20-Poly1305 (AEAD)
  - 密钥派生: HKDF-SHA256
  - 签名: Ed25519 (用于 machine_key 身份验证)

┌─────────────────────────────────────────────────────────────────────────────────┐
│                         密钥协商流程                                             │
│                                                                                 │
│  Node A                        Controller                        Node B         │
│    │                               │                               │           │
│    │  1. 获取配置 (含 B 的 node_key_pub)                           │           │
│    │◄──────────────────────────────┤                               │           │
│    │                               │                               │           │
│    │  2. 本地计算共享密钥                                           │           │
│    │  shared = X25519(A_node_priv, B_node_pub)                     │           │
│    │  session_key = HKDF(shared, "wss-mesh-session", A_id || B_id) │           │
│    │                               │                               │           │
│    │                               │  (B 收到 A 的 node_key_pub 后  │           │
│    │                               │   计算相同的 session_key)      │           │
│    │                               │                               │           │
│    │  3. 使用 session_key 加密通信                                  │           │
│    │◄══════════════════════════════╪══════════════════════════════►│           │
│    │         ChaCha20-Poly1305                                     │           │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘

加密数据包格式:

┌────────────┬────────────┬──────────────┬─────────────────────┬──────────────┐
│  Nonce     │  Counter   │  Encrypted   │  原始 IP 包         │  Auth Tag    │
│  (12 B)    │  (8 B)     │  Header      │  (Ciphertext)       │  (16 B)      │
└────────────┴────────────┴──────────────┴─────────────────────┴──────────────┘

Nonce 生成策略:
  - 前 4 字节: 随机数 (会话建立时生成)
  - 后 8 字节: 递增计数器 (防重放)
  
重放攻击防护:
  - 接收方维护滑动窗口 (默认 2048)
  - 拒绝窗口外或已见过的 counter
```

### 3.3 前向保密 (Perfect Forward Secrecy)

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                         密钥轮换机制                                             │
│                                                                                 │
│  node_key 轮换周期: 24 小时 (可配置)                                            │
│                                                                                 │
│  轮换流程:                                                                       │
│  1. 节点生成新的 X25519 密钥对                                                   │
│  2. 用 machine_key 签名新的 node_key_pub                                        │
│  3. 上报到 Controller                                                           │
│  4. Controller 验证签名，更新数据库                                              │
│  5. 通过 config_update 推送给所有在线节点                                        │
│  6. 各节点重新计算 session_key                                                   │
│                                                                                 │
│  旧密钥处理:                                                                     │
│  - 保留旧 session_key 5 分钟，处理在途数据包                                     │
│  - 5 分钟后安全擦除旧密钥                                                        │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 3.4 信任模型

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              信任模型                                            │
│                                                                                 │
│  Controller: 可信任 (但不能解密数据)                                            │
│  Relay:      不可信任 (只做转发，看不到明文)                                    │
│  其他节点:   通过 Controller 分发的公钥验证身份                                  │
│                                                                                 │
│  防护措施:                                                                       │
│  1. 节点身份验证                                                                │
│     - 每个节点的 machine_key_pub 在首次注册时绑定                               │
│     - node_key 更新必须用 machine_key 签名                                      │
│     - Controller 验证签名链                                                     │
│                                                                                 │
│  2. Relay 不可解密                                                              │
│     - Relay 只看到加密后的数据                                                  │
│     - 无法获知 session_key                                                      │
│     - 只能看到 src_node_id 和 dst_node_id                                       │
│                                                                                 │
│  3. Controller 不参与数据加密                                                   │
│     - Controller 只分发公钥                                                     │
│     - 不接触任何私钥                                                            │
│     - 即使 Controller 被攻破，历史通信仍安全                                    │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 4. Token 机制

### 4.1 Token 类型

| 类型 | 用途 | 有效期 |
|------|------|--------|
| auth_token | 节点认证，连接 Controller 控制通道 | 24 小时 |
| relay_token | Relay 连接，连接数据平面 | 1.5 小时 |
| admin_token | 管理后台，访问 REST API | 8 小时 |
| server_token | Relay/STUN 服务器身份认证 | 1 年 |

### 4.2 JWT 结构

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                         auth_token (节点认证)                                    │
├─────────────────────────────────────────────────────────────────────────────────┤
│ {                                                                               │
│   "type": "auth",                                                               │
│   "node_id": 123,                                                               │
│   "machine_key_hash": "sha256:abc123...",                                       │
│   "network_id": 1,                                                              │
│   "virtual_ip": "10.0.1.5",                                                     │
│   "iat": 1704067200,                                                            │
│   "exp": 1704153600,                                                            │
│   "jti": "unique-token-id"                                                      │
│ }                                                                               │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│                         relay_token (Relay 连接)                                 │
├─────────────────────────────────────────────────────────────────────────────────┤
│ {                                                                               │
│   "type": "relay",                                                              │
│   "node_id": 123,                                                               │
│   "network_id": 1,                                                              │
│   "allowed_relays": [1, 2, 3],                                                  │
│   "iat": 1704067200,                                                            │
│   "exp": 1704072600,                                                            │
│   "jti": "unique-token-id"                                                      │
│ }                                                                               │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│                         server_token (Relay/STUN 服务器)                         │
├─────────────────────────────────────────────────────────────────────────────────┤
│ {                                                                               │
│   "type": "server",                                                             │
│   "server_id": 1,                                                               │
│   "server_name": "relay-asia-1",                                                │
│   "capabilities": ["relay", "stun"],                                            │
│   "region": "asia",                                                             │
│   "iat": 1704067200,                                                            │
│   "exp": 1735689600,                                                            │
│   "jti": "unique-token-id"                                                      │
│ }                                                                               │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 4.3 Token 验证与撤销

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                         Relay 验证 relay_token                                   │
│                                                                                 │
│  方案: Relay 本地验证 (共享 JWT Secret)                                         │
│                                                                                 │
│  验证步骤:                                                                       │
│  1. 验证签名 (共享 secret)                                                      │
│  2. 检查 exp 是否过期                                                           │
│  3. 检查 server_id 是否在 allowed_relays 中                                     │
│  4. 检查 jti 是否在黑名单中                                                     │
│                                                                                 │
│  刷新策略:                                                                       │
│  - auth_token: 有效期 24h，在剩余 2h 时自动刷新                                 │
│  - relay_token: 有效期 1.5h，在剩余 15min 时自动刷新                            │
│                                                                                 │
│  撤销机制:                                                                       │
│  - 节点被删除/取消授权: jti 加入黑名单，广播给所有 Relay                         │
│  - 黑名单通过 WebSocket 实时同步                                                 │
│  - 黑名单条目在原 Token 过期后自动清理                                           │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 5. 组件设计

### 5.1 Controller

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              Controller                                          │
│                                                                                 │
│  ┌───────────────────────────────────────────────────────────────────────────┐  │
│  │                           HTTP Server (443)                               │  │
│  │                                                                           │  │
│  │  /api/v1/auth/*          认证相关 API                                     │  │
│  │  /api/v1/nodes/*         节点管理 API                                     │  │
│  │  /api/v1/network/*       网络配置 API                                     │  │
│  │  /api/v1/servers/*       服务器管理 API                                   │  │
│  │  /api/v1/latency/*       延迟数据 API                                     │  │
│  │  /ws/control             客户端控制连接 (WSS)                             │  │
│  │  /ws/server              Relay/STUN 服务器连接 (WSS)                      │  │
│  │                                                                           │  │
│  └───────────────────────────────────────────────────────────────────────────┘  │
│                                                                                 │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐                 │
│  │  Auth Service   │  │  Node Registry  │  │  Config Manager │                 │
│  │                 │  │                 │  │                 │                 │
│  │  - 密钥验证     │  │  - 节点状态     │  │  - Relay 列表   │                 │
│  │  - Token 签发   │  │  - IP 分配      │  │  - STUN 列表    │                 │
│  │  - Token 撤销   │  │  - 在线管理     │  │  - 子网路由     │                 │
│  │  - 黑名单管理   │  │  - 公钥分发     │  │  - 配置版本     │                 │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘                 │
│                                                                                 │
│  ┌─────────────────┐  ┌─────────────────┐                                      │
│  │ Latency Service │  │ Server Manager  │                                      │
│  │                 │  │                 │                                      │
│  │ - 收集延迟数据  │  │ - 服务器注册    │                                      │
│  │ - 计算最优路径  │  │ - 黑名单同步    │                                      │
│  │ - 路径缓存      │  │ - 状态监控      │                                      │
│  └─────────────────┘  └─────────────────┘                                      │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                    内置 Relay + STUN (可选)                              │   │
│  │                                                                         │   │
│  │  enable_relay: true    # 启用内置 Relay                                 │   │
│  │  enable_stun: true     # 启用内置 STUN (需要真实公网 IP)                 │   │
│  │  stun_external_ip: "203.0.113.1"   # STUN 必须配置                      │   │
│  │                                                                         │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                         Database Layer                                   │   │
│  │                    (MariaDB / SQLite 可切换)                             │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 5.2 Relay/STUN Server (独立部署)

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        Relay/STUN Server                                         │
│                                                                                 │
│  单一二进制，可选启用功能:                                                       │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │  enable_relay: true/false                                               │   │
│  │  enable_stun: true/false                                                │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  ┌───────────────────────────────────────────────────────────────────────────┐  │
│  │                    Relay 模块 (enable_relay: true)                        │  │
│  │                                                                           │  │
│  │  WSS Server (443)    ← 可以放在 CDN 后面                                  │  │
│  │  ├── /ws/data        客户端数据连接                                       │  │
│  │  └── /ws/mesh        Relay 间 Mesh 连接                                   │  │
│  │                                                                           │  │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐           │  │
│  │  │ Connection Pool │  │  Frame Router   │  │  Mesh Manager   │           │  │
│  │  │ node_id → conn  │  │ 解析目标 ID     │  │ 其他 Relay 连接 │           │  │
│  │  │ 本地节点映射    │  │ 本地/远程判断   │  │ 延迟测量        │           │  │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘           │  │
│  │                                                                           │  │
│  │  ┌─────────────────┐  ┌─────────────────┐                                │  │
│  │  │  Token Manager  │  │ Latency Reporter│                                │  │
│  │  │ - JWT 本地验证  │  │ - 节点延迟上报  │                                │  │
│  │  │ - 黑名单缓存    │  │ - Relay间延迟   │                                │  │
│  │  └─────────────────┘  └─────────────────┘                                │  │
│  │                                                                           │  │
│  └───────────────────────────────────────────────────────────────────────────┘  │
│                                                                                 │
│  ┌───────────────────────────────────────────────────────────────────────────┐  │
│  │                    STUN 模块 (enable_stun: true)                          │  │
│  │                                                                           │  │
│  │  UDP Server (3478)   ← 必须真实公网 IP，不能用 CDN                        │  │
│  │                                                                           │  │
│  │  配置要求:                                                                │  │
│  │  ┌─────────────────────────────────────────────────────────────────────┐ │  │
│  │  │  external_ip: "203.0.113.100"      # 必须配置，服务器公网 IP         │ │  │
│  │  │  secondary_ip: "203.0.113.101"     # 可选，用于完整 NAT 类型检测     │ │  │
│  │  └─────────────────────────────────────────────────────────────────────┘ │  │
│  │                                                                           │  │
│  │  功能:                                                                    │  │
│  │  - Binding Request → 返回客户端公网 IP:Port                              │  │
│  │  - NAT 类型检测 (需要 secondary_ip)                                      │  │
│  │  - 标准 STUN 协议 (RFC 5389)                                             │  │
│  │                                                                           │  │
│  └───────────────────────────────────────────────────────────────────────────┘  │
│                                                                                 │
│  ┌───────────────────────────────────────────────────────────────────────────┐  │
│  │                    Controller 连接 (仅控制平面)                           │  │
│  │                                                                           │  │
│  │  - 启动时连接 Controller (/ws/server)                                     │  │
│  │  - 注册自身信息 (capabilities: ["relay", "stun"])                        │  │
│  │  - 接收其他 Relay 列表 (用于建立 Mesh 连接)                              │  │
│  │  - 接收节点位置同步 (哪个节点在哪个 Relay)                               │  │
│  │  - 接收黑名单同步                                                        │  │
│  │  - 上报延迟数据                                                          │  │
│  │  - 不通过 Controller 转发数据！数据走 Mesh 直连                          │  │
│  │                                                                           │  │
│  └───────────────────────────────────────────────────────────────────────────┘  │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 5.3 延迟测量与路径选择

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                         延迟测量系统                                             │
│                                                                                 │
│  测量内容:                                                                       │
│  1. Node → Relay 延迟 (每个节点到每个 Relay)                                    │
│  2. Relay → Relay 延迟 (通过 Mesh 连接直接测量)                                 │
│                                                                                 │
│  测量方式:                                                                       │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │ Node → Relay:                                                           │   │
│  │   - 节点定期 (30s) 向所有连接的 Relay 发送 PING                          │   │
│  │   - Relay 立即回复 PONG                                                  │   │
│  │   - 节点计算 RTT，上报给 Controller                                      │   │
│  │                                                                         │   │
│  │ Relay → Relay (通过 Mesh 直连测量):                                     │   │
│  │   - Relay 间通过 /ws/mesh 连接定期 (30s) 互相 PING                       │   │
│  │   - 直接测量 RTT，上报给 Controller                                      │   │
│  │   - 注意: 测量走 Mesh 连接，不经过 Controller                           │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  路径计算 (Controller 侧 - 只计算，不转发):                                      │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │ func calculate_best_path(src_node, dst_node):                           │   │
│  │   paths = []                                                            │   │
│  │                                                                         │   │
│  │   # 直连路径 (同一 Relay)                                                │   │
│  │   common_relays = src_relays ∩ dst_relays                               │   │
│  │   for relay in common_relays:                                           │   │
│  │     latency = latency[src→relay] + latency[relay→dst]                   │   │
│  │     paths.append({relay: relay, latency: latency, hops: 1})             │   │
│  │                                                                         │   │
│  │   # 跨 Relay 路径 (通过 Relay Mesh 转发)                                 │   │
│  │   for src_relay in src_relays:                                          │   │
│  │     for dst_relay in dst_relays:                                        │   │
│  │       if src_relay != dst_relay:                                        │   │
│  │         latency = latency[src→src_relay]                                │   │
│  │                 + latency[src_relay→dst_relay]  # Relay间Mesh延迟       │   │
│  │                 + latency[dst_relay→dst]                                │   │
│  │         paths.append({hops: 2, ...})                                    │   │
│  │                                                                         │   │
│  │   return min(paths, key=lambda p: p.latency)                            │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  路径下发与使用:                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │ 1. Controller 计算最优路径后，通知相关节点和 Relay                       │   │
│  │ 2. 节点根据路径信息选择发送数据的目标 Relay                              │   │
│  │ 3. Relay 收到数据包后:                                                   │   │
│  │    - 目标节点在本地 → 直接转发给节点                                     │   │
│  │    - 目标节点在其他 Relay → 通过 Mesh 连接转发 (不经过Controller)        │   │
│  │                                                                         │   │
│  │ 重要: Controller 不参与数据转发，只提供路径决策信息！                    │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 5.4 Client (客户端)

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              Client                                              │
│                                                                                 │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐                 │
│  │ Control Channel │  │  Relay Manager  │  │   P2P Manager   │                 │
│  │                 │  │                 │  │                 │                 │
│  │ - 连接Controller│  │ - 多 Relay 连接 │  │ - STUN 探测     │                 │
│  │ - 接收配置更新  │  │ - 延迟测量上报  │  │ - UDP 打洞      │                 │
│  │ - 心跳保活      │  │ - 路径选择      │  │ - 直连管理      │                 │
│  │ - Token 刷新    │  │ - 故障切换      │  │ - Keepalive     │                 │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘                 │
│                                                                                 │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐                 │
│  │  Crypto Engine  │  │   TUN Device    │  │  Route Manager  │                 │
│  │                 │  │                 │  │                 │                 │
│  │ - X25519 ECDH   │  │ - 虚拟网卡      │  │ - 路由表管理    │                 │
│  │ - ChaCha20-Poly │  │ - IP 包收发     │  │ - 子网路由      │                 │
│  │ - 密钥轮换      │  │ - MTU 处理      │  │ - 优先级排序    │                 │
│  │ - 重放检测      │  │                 │  │                 │                 │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘                 │
│                                                                                 │
│  ┌─────────────────┐                                                           │
│  │ Endpoint Manager│                                                           │
│  │                 │                                                           │
│  │ - 本地 IP 收集  │                                                           │
│  │ - STUN 端点     │                                                           │
│  │ - 端点优先级    │                                                           │
│  └─────────────────┘                                                           │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 6. P2P 直连设计

### 6.1 NAT 类型检测

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           NAT 类型及打洞可行性                                   │
├─────────────────────┬───────────────────────────────────────────────────────────┤
│ NAT 类型            │ 打洞可行性                                                │
├─────────────────────┼───────────────────────────────────────────────────────────┤
│ Full Cone           │ ✅ 容易，任何人都可以连入                                 │
│ Restricted Cone     │ ✅ 可行，需要先发包                                       │
│ Port Restricted     │ ✅ 可行，需要精确端口                                     │
│ Symmetric           │ ⚠️ 困难，端口不可预测                                     │
└─────────────────────┴───────────────────────────────────────────────────────────┘

打洞可行性矩阵:
              │ Full │ Restricted │ Port Restr │ Symmetric │
──────────────┼──────┼────────────┼────────────┼───────────┤
Full          │  ✅  │     ✅     │     ✅     │    ✅     │
Restricted    │  ✅  │     ✅     │     ✅     │    ✅     │
Port Restr    │  ✅  │     ✅     │     ✅     │    ⚠️     │
Symmetric     │  ✅  │     ✅     │     ⚠️     │    ❌     │
```

### 6.2 端点收集与选择

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           端点收集策略                                           │
│                                                                                 │
│  收集的端点类型:                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │ 类型     │ 来源               │ 优先级 │ 说明                           │   │
│  ├──────────┼────────────────────┼────────┼────────────────────────────────┤   │
│  │ lan      │ 本地网卡           │ 1 (高) │ 192.168.x.x, 10.x.x.x 等       │   │
│  │ stun     │ STUN 探测          │ 2      │ 公网 IP:Port                   │   │
│  │ upnp     │ UPnP/NAT-PMP       │ 2      │ 端口映射后的公网地址           │   │
│  │ relay    │ Relay 观测         │ 3 (低) │ Relay 看到的客户端地址         │   │
│  └──────────┴────────────────────┴────────┴────────────────────────────────┘   │
│                                                                                 │
│  连接选择逻辑:                                                                   │
│  1. 检查是否已有活跃 P2P 连接 → 使用                                            │
│  2. 检查是否在同一局域网 → 尝试局域网直连                                        │
│  3. 检查 P2P 打洞可行性 → 尝试 STUN 打洞                                        │
│  4. 回退到 Relay (选择最优路径)                                                 │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 6.3 打洞流程

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              P2P 打洞流程                                        │
│                                                                                 │
│  Node A                      Controller                      Node B             │
│    │                             │                             │               │
│    │  1. 请求与 B 建立 P2P       │                             │               │
│    │────────────────────────────►│                             │               │
│    │                             │  2. 转发端点信息            │               │
│    │                             │────────────────────────────►│               │
│    │  3. 收到 B 的端点           │◄────────────────────────────│               │
│    │◄────────────────────────────│                             │               │
│    │                             │                             │               │
│    │  4. 双方同时发送 UDP 打洞包                                │               │
│    │─────────────────────────────────────────────────────────►│               │
│    │◄─────────────────────────────────────────────────────────│               │
│    │                             │                             │               │
│    │  5. 收到对方包，发送加密 P2P_PING                          │               │
│    │═════════════════════════════════════════════════════════►│               │
│    │◄═════════════════════════════════════════════════════════│               │
│    │                             │                             │               │
│    │  6. P2P 连接建立成功                                       │               │
│                                                                                 │
│  打洞超时: 5 秒 | 重试次数: 3 次 | 重试间隔: 2 秒                               │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 6.4 NAT Keepalive

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           NAT Keepalive 机制                                     │
│                                                                                 │
│  问题: UDP NAT 映射会超时 (通常 30-120 秒)                                       │
│                                                                                 │
│  Keepalive 参数:                                                                │
│  - 间隔: 25 秒 (低于最短 NAT 超时 30s)                                          │
│  - 包类型: P2P_KEEPALIVE (轻量，14 字节)                                        │
│  - 超时检测: 3 次连续丢失视为断开                                               │
│                                                                                 │
│  Keepalive 包格式:                                                              │
│  ┌──────────┬──────────┬──────────┬──────────┐                                 │
│  │ Type(1B) │ Src(4B)  │ Seq(4B)  │ Ts(4B)   │  = 14 bytes (不加密)            │
│  └──────────┴──────────┴──────────┴──────────┘                                 │
│                                                                                 │
│  连接断开处理:                                                                   │
│  1. 标记 P2P 连接为 inactive                                                    │
│  2. 立即切换到 Relay 通道 (无缝切换)                                            │
│  3. 后台尝试重新打洞                                                            │
│                                                                                 │
│  自适应调整:                                                                     │
│  - 连续 10 次成功后可增加间隔 (最大 55s)                                        │
│  - 有丢包立即恢复 25s                                                           │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 7. 子网路由设计

### 7.1 路由优先级与权重

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           路由优先级系统                                         │
│                                                                                 │
│  场景: 多个节点宣告相同子网                                                      │
│                                                                                 │
│  ┌──────────┐  宣告 192.168.1.0/24  (priority=100, weight=50)                  │
│  │ Gateway1 │  主网关                                                           │
│  └──────────┘                                                                   │
│                                                                                 │
│  ┌──────────┐  宣告 192.168.1.0/24  (priority=100, weight=50)                  │
│  │ Gateway2 │  负载均衡 (同优先级)                                              │
│  └──────────┘                                                                   │
│                                                                                 │
│  ┌──────────┐  宣告 192.168.1.0/24  (priority=50, weight=100)                  │
│  │ Backup   │  备份网关 (低优先级)                                              │
│  └──────────┘                                                                   │
│                                                                                 │
│  路由属性:                                                                       │
│  ┌───────────┬─────────┬───────────┬────────────────────────────────────────┐  │
│  │ 字段      │ 类型    │ 范围      │ 说明                                   │  │
│  ├───────────┼─────────┼───────────┼────────────────────────────────────────┤  │
│  │ cidr      │ string  │ -         │ 网段，如 192.168.1.0/24                │  │
│  │ priority  │ uint16  │ 0-65535   │ 优先级，越大越优先                     │  │
│  │ weight    │ uint16  │ 1-65535   │ 权重，用于同优先级负载均衡             │  │
│  │ enabled   │ bool    │ -         │ 是否启用                               │  │
│  └───────────┴─────────┴───────────┴────────────────────────────────────────┘  │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 7.2 路由选择算法

```
func select_route(dst_ip):
  # 1. 找出所有匹配的路由 (最长前缀匹配)
  matching = [r for r in routes if dst_ip in r.cidr and r.enabled]
  
  # 2. 按最长前缀筛选
  longest_prefix = max(r.prefix_len for r in matching)
  candidates = [r for r in matching if r.prefix_len == longest_prefix]
  
  # 3. 按优先级筛选
  max_priority = max(r.priority for r in candidates)
  candidates = [r for r in candidates if r.priority == max_priority]
  
  # 4. 过滤离线网关
  candidates = [r for r in candidates if r.gateway_node.online]
  
  # 5. 按权重随机选择
  if len(candidates) == 1:
    return candidates[0]
  else:
    # 加权随机
    total = sum(r.weight for r in candidates)
    rand = random(0, total)
    cumulative = 0
    for route in candidates:
      cumulative += route.weight
      if rand < cumulative:
        return route
```

### 7.3 故障转移

```
正常状态:
  192.168.1.0/24 → Gateway1 (priority=100, online=true)  ← 使用中
  192.168.1.0/24 → Backup   (priority=50, online=true)   ← 备用

Gateway1 离线后:
  192.168.1.0/24 → Gateway1 (priority=100, online=false) ← 跳过
  192.168.1.0/24 → Backup   (priority=50, online=true)   ← 自动启用

切换延迟: < 5 秒 (取决于心跳检测间隔)
```

---

## 8. 协议设计

### 8.1 帧格式

```
基础帧格式 (所有 WSS 消息):

┌──────────┬──────────┬──────────┬──────────────────────────────────────────┐
│ Version  │  Type    │  Flags   │  Length                                  │
│  (1B)    │  (1B)    │  (1B)    │  (2B, Big Endian)                        │
├──────────┴──────────┴──────────┴──────────────────────────────────────────┤
│                            Payload                                        │
│                       (Length bytes)                                      │
└───────────────────────────────────────────────────────────────────────────┘

字段说明:
- Version: 协议版本，当前为 0x01
- Type: 消息类型
- Flags: 标志位 (bit 0: 需要 ACK, bit 1: 压缩)
- Length: Payload 长度 (0-65535)

总头部大小: 5 字节
```

### 8.2 消息类型

```
┌──────────────────┬────────┬─────────────────────────────────────────────────────┐
│ Type             │ 值     │ 说明                                                │
├──────────────────┼────────┼─────────────────────────────────────────────────────┤
│ AUTH_REQUEST     │ 0x01   │ 认证请求                                            │
│ AUTH_RESPONSE    │ 0x02   │ 认证响应                                            │
│ CONFIG           │ 0x03   │ 完整配置下发                                        │
│ CONFIG_UPDATE    │ 0x04   │ 配置增量更新                                        │
│ DATA             │ 0x10   │ 加密数据转发                                        │
│ PING             │ 0x20   │ 心跳请求                                            │
│ PONG             │ 0x21   │ 心跳响应                                            │
│ LATENCY_REPORT   │ 0x22   │ 延迟上报                                            │
│ P2P_INIT         │ 0x30   │ P2P 连接初始化                                      │
│ P2P_ENDPOINT     │ 0x31   │ P2P 端点交换                                        │
│ P2P_PING         │ 0x32   │ P2P 探测 (UDP)                                      │
│ P2P_PONG         │ 0x33   │ P2P 确认 (UDP)                                      │
│ P2P_KEEPALIVE    │ 0x34   │ P2P 保活 (UDP)                                      │
│ P2P_STATUS       │ 0x35   │ P2P 状态上报                                        │
│ SERVER_REGISTER  │ 0x40   │ Relay/STUN 服务器注册                               │
│ SERVER_NODE_LOC  │ 0x41   │ 节点位置同步                                        │
│ SERVER_BLACKLIST │ 0x42   │ Token 黑名单同步                                    │
│ ERROR            │ 0xFF   │ 错误响应                                            │
└──────────────────┴────────┴─────────────────────────────────────────────────────┘
```

### 8.3 数据帧格式 (DATA)

```
DATA Payload:

┌──────────┬──────────┬──────────┬──────────────────────────────┬───────┐
│ Src Node │ Dst Node │  Nonce   │ Encrypted Payload            │ Tag   │
│   (4B)   │   (4B)   │  (12B)   │ (Variable)                   │ (16B) │
└──────────┴──────────┴──────────┴──────────────────────────────┴───────┘

字段说明:
- Src/Dst Node: 明文，用于 Relay 路由
- Nonce: 4B 随机数 + 8B 计数器
- Encrypted Payload: ChaCha20-Poly1305 加密的原始 IP 包
- Tag: AEAD 认证标签

MTU 计算:
原始 MTU:     1500
- 外层 IP:    20
- UDP/WSS:    8-14
- 协议头:     5
- DATA 头:    20 (4+4+12)
- Tag:        16
─────────────────────
建议 TUN MTU: 1400
```

### 8.4 错误码定义

```
┌──────────┬─────────────────────────────────────────────────────────────────┐
│ 码段     │ 说明                                                            │
├──────────┼─────────────────────────────────────────────────────────────────┤
│ 1xxx     │ 认证错误                                                        │
│ 1001     │ 无效 Token                                                      │
│ 1002     │ Token 过期                                                      │
│ 1003     │ Token 已撤销                                                    │
│ 1004     │ 无效 machine_key                                                │
│ 1005     │ 签名验证失败                                                    │
│ 1006     │ 节点未授权                                                      │
│ 2xxx     │ 协议错误                                                        │
│ 2001     │ 不支持的协议版本                                                │
│ 2002     │ 无效消息格式                                                    │
│ 2003     │ 消息过大                                                        │
│ 3xxx     │ 路由错误                                                        │
│ 3001     │ 目标节点不存在                                                  │
│ 3002     │ 目标节点离线                                                    │
│ 3003     │ 无可用路由                                                      │
│ 4xxx     │ 服务器错误                                                      │
│ 4001     │ 内部错误                                                        │
│ 4002     │ 服务不可用                                                      │
│ 4003     │ 过载                                                            │
└──────────┴─────────────────────────────────────────────────────────────────┘
```

---

## 9. 数据库设计

### 9.1 ER 图

```
┌─────────────────┐       ┌─────────────────┐       ┌─────────────────┐
│    networks     │       │     nodes       │       │   node_routes   │
├─────────────────┤       ├─────────────────┤       ├─────────────────┤
│ id (PK)         │       │ id (PK)         │       │ id (PK)         │
│ name            │───┐   │ network_id (FK) │───┐   │ node_id (FK)    │
│ subnet          │   │   │ name            │   │   │ cidr            │
│ created_at      │   │   │ machine_key     │   │   │ priority        │
│ updated_at      │   └──►│ node_key        │   └──►│ weight          │
└─────────────────┘       │ virtual_ip      │       │ enabled         │
                          │ hostname        │       │ created_at      │
                          │ os / arch       │       └─────────────────┘
                          │ version         │
                          │ nat_type        │
                          │ online          │
                          │ last_seen       │
                          │ authorized      │
                          │ created_at      │
                          └─────────────────┘

┌─────────────────┐       ┌─────────────────┐       ┌─────────────────┐
│    servers      │       │ node_endpoints  │       │ latency_records │
├─────────────────┤       ├─────────────────┤       ├─────────────────┤
│ id (PK)         │       │ id (PK)         │       │ id (PK)         │
│ name            │       │ node_id (FK)    │       │ src_type        │
│ type            │       │ type            │       │ src_id          │
│ url             │       │ ip              │       │ dst_type        │
│ region          │       │ port            │       │ dst_id          │
│ capabilities    │       │ priority        │       │ rtt_ms          │
│ stun_ip         │       │ updated_at      │       │ recorded_at     │
│ stun_ip2        │       └─────────────────┘       └─────────────────┘
│ enabled         │
│ token           │       ┌─────────────────┐       ┌─────────────────┐
│ last_heartbeat  │       │ token_blacklist │       │    settings     │
│ created_at      │       ├─────────────────┤       ├─────────────────┤
└─────────────────┘       │ jti (PK)        │       │ key (PK)        │
                          │ node_id         │       │ value           │
┌─────────────────┐       │ reason          │       │ updated_at      │
│  audit_logs     │       │ expires_at      │       └─────────────────┘
├─────────────────┤       │ created_at      │
│ id (PK)         │       └─────────────────┘
│ actor_type      │
│ actor_id        │       ┌─────────────────┐
│ action          │       │node_server_conns│
│ target_type     │       ├─────────────────┤
│ target_id       │       │ node_id (FK)    │
│ details         │       │ server_id (FK)  │
│ ip_address      │       │ connected_at    │
│ created_at      │       │ last_ping       │
└─────────────────┘       └─────────────────┘
```

### 9.2 SQL Schema

```sql
-- ============================================================================
-- 网络表
-- ============================================================================
CREATE TABLE networks (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name VARCHAR(255) NOT NULL,
    subnet VARCHAR(50) NOT NULL,
    description TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

INSERT INTO networks (name, subnet) VALUES ('default', '10.0.1.0/24');

-- ============================================================================
-- 节点表
-- ============================================================================
CREATE TABLE nodes (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    network_id INTEGER NOT NULL DEFAULT 1,
    name VARCHAR(255) NOT NULL,
    
    machine_key_pub VARCHAR(255) UNIQUE NOT NULL,
    node_key_pub VARCHAR(255),
    node_key_updated_at DATETIME,
    
    virtual_ip VARCHAR(15) UNIQUE,
    hostname VARCHAR(255),
    os VARCHAR(50),
    arch VARCHAR(50),
    version VARCHAR(50),
    nat_type VARCHAR(50),
    
    online BOOLEAN DEFAULT FALSE,
    last_seen DATETIME,
    authorized BOOLEAN DEFAULT FALSE,
    
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (network_id) REFERENCES networks(id)
);

CREATE INDEX idx_nodes_network ON nodes(network_id);
CREATE INDEX idx_nodes_online ON nodes(online);

-- ============================================================================
-- 节点端点表
-- ============================================================================
CREATE TABLE node_endpoints (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    node_id INTEGER NOT NULL,
    type VARCHAR(20) NOT NULL,
    ip VARCHAR(45) NOT NULL,
    port INTEGER NOT NULL,
    priority INTEGER DEFAULT 2,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (node_id) REFERENCES nodes(id) ON DELETE CASCADE,
    UNIQUE(node_id, type, ip, port)
);

-- ============================================================================
-- 节点路由表
-- ============================================================================
CREATE TABLE node_routes (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    node_id INTEGER NOT NULL,
    cidr VARCHAR(50) NOT NULL,
    priority INTEGER DEFAULT 100,
    weight INTEGER DEFAULT 100,
    enabled BOOLEAN DEFAULT TRUE,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (node_id) REFERENCES nodes(id) ON DELETE CASCADE,
    UNIQUE(node_id, cidr)
);

-- ============================================================================
-- 服务器表 (Relay/STUN 统一管理)
-- ============================================================================
CREATE TABLE servers (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name VARCHAR(255) NOT NULL,
    type VARCHAR(20) NOT NULL DEFAULT 'external',  -- builtin, external
    url VARCHAR(255),                               -- Relay WSS URL (可为空表示只有 STUN)
    region VARCHAR(50),
    capabilities TEXT NOT NULL DEFAULT '["relay"]', -- JSON: ["relay"], ["stun"], ["relay","stun"]
    
    -- STUN 配置 (启用 STUN 时必填)
    stun_ip VARCHAR(45),                           -- STUN 主 IP (真实公网 IP)
    stun_ip2 VARCHAR(45),                          -- STUN 备用 IP (可选)
    stun_port INTEGER DEFAULT 3478,
    
    enabled BOOLEAN DEFAULT TRUE,
    server_token TEXT,
    last_heartbeat DATETIME,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- ============================================================================
-- 延迟记录
-- ============================================================================
CREATE TABLE latency_records (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    src_type VARCHAR(20) NOT NULL,
    src_id INTEGER NOT NULL,
    dst_type VARCHAR(20) NOT NULL,
    dst_id INTEGER NOT NULL,
    rtt_ms INTEGER NOT NULL,
    recorded_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    
    UNIQUE(src_type, src_id, dst_type, dst_id)
);

-- ============================================================================
-- Token 黑名单
-- ============================================================================
CREATE TABLE token_blacklist (
    jti VARCHAR(255) PRIMARY KEY,
    node_id INTEGER,
    reason VARCHAR(255),
    expires_at DATETIME NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- ============================================================================
-- 节点-服务器连接状态
-- ============================================================================
CREATE TABLE node_server_connections (
    node_id INTEGER NOT NULL,
    server_id INTEGER NOT NULL,
    connected_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    last_ping DATETIME,
    
    PRIMARY KEY (node_id, server_id),
    FOREIGN KEY (node_id) REFERENCES nodes(id) ON DELETE CASCADE,
    FOREIGN KEY (server_id) REFERENCES servers(id) ON DELETE CASCADE
);

-- ============================================================================
-- 系统设置
-- ============================================================================
CREATE TABLE settings (
    key VARCHAR(255) PRIMARY KEY,
    value TEXT,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

INSERT INTO settings (key, value) VALUES 
    ('jwt_secret', 'CHANGE_ME_TO_RANDOM_SECRET'),
    ('auth_token_expire_hours', '24'),
    ('relay_token_expire_hours', '1.5'),
    ('node_key_rotate_hours', '24'),
    ('keepalive_interval_seconds', '25');

-- ============================================================================
-- 审计日志
-- ============================================================================
CREATE TABLE audit_logs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    actor_type VARCHAR(50) NOT NULL,
    actor_id VARCHAR(255),
    action VARCHAR(100) NOT NULL,
    target_type VARCHAR(50),
    target_id INTEGER,
    details TEXT,
    ip_address VARCHAR(45),
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_audit_created ON audit_logs(created_at);
```

---

## 10. API 设计

### 10.1 REST API

```
认证:
POST   /api/v1/auth/login               登录 (管理后台)
POST   /api/v1/auth/logout              登出
GET    /api/v1/auth/me                  当前用户信息

节点管理:
GET    /api/v1/nodes                    节点列表
GET    /api/v1/nodes/:id                节点详情
POST   /api/v1/nodes/:id/authorize      授权节点
DELETE /api/v1/nodes/:id                删除节点
GET    /api/v1/nodes/:id/routes         节点路由列表
POST   /api/v1/nodes/:id/routes         添加节点路由
PUT    /api/v1/nodes/:id/routes/:rid    更新路由 (优先级/权重)
DELETE /api/v1/nodes/:id/routes/:rid    删除路由

网络管理:
GET    /api/v1/networks                 网络列表
POST   /api/v1/networks                 创建网络
PUT    /api/v1/networks/:id             更新网络
DELETE /api/v1/networks/:id             删除网络

路由管理:
GET    /api/v1/routes                   聚合路由表 (按 CIDR 分组)

服务器管理:
GET    /api/v1/servers                  服务器列表
POST   /api/v1/servers                  添加服务器
PUT    /api/v1/servers/:id              更新服务器
DELETE /api/v1/servers/:id              删除服务器
POST   /api/v1/servers/:id/token        重新生成 Token

延迟数据:
GET    /api/v1/latency/matrix           延迟矩阵
GET    /api/v1/latency/paths            最优路径表

设置:
GET    /api/v1/settings                 获取设置
PUT    /api/v1/settings                 更新设置

统计:
GET    /api/v1/stats/overview           概览统计
```

### 10.2 WebSocket API

```
Controller:
  /ws/control     客户端控制通道
  /ws/server      Relay/STUN 服务器通道

Relay:
  /ws/data        客户端数据通道
  /ws/mesh        Relay 间 Mesh 通道
```

---

## 11. 目录结构

```
wss-mesh/
├── CMakeLists.txt
├── README.md
│
├── src/
│   ├── common/                     # 公共代码
│   │   ├── protocol.hpp
│   │   ├── frame.hpp
│   │   ├── crypto/
│   │   │   ├── x25519.hpp
│   │   │   ├── chacha20.hpp
│   │   │   ├── ed25519.hpp
│   │   │   └── hkdf.hpp
│   │   ├── config.hpp
│   │   ├── log.hpp
│   │   └── jwt.hpp
│   │
│   ├── controller/                 # 控制器
│   │   ├── main.cpp
│   │   ├── server.hpp
│   │   ├── auth.hpp
│   │   ├── registry.hpp
│   │   ├── config_mgr.hpp
│   │   ├── latency.hpp
│   │   ├── token_mgr.hpp
│   │   ├── builtin_relay.hpp       # 内置 Relay
│   │   ├── builtin_stun.hpp        # 内置 STUN
│   │   ├── api/
│   │   └── db/
│   │
│   ├── server/                     # Relay/STUN 服务器 (独立部署)
│   │   ├── main.cpp
│   │   ├── relay/
│   │   │   ├── server.hpp
│   │   │   ├── forwarder.hpp
│   │   │   └── mesh_manager.hpp
│   │   ├── stun/
│   │   │   └── server.hpp
│   │   ├── token_validator.hpp
│   │   └── controller_client.hpp
│   │
│   └── client/                     # 客户端
│       ├── main.cpp
│       ├── control.hpp
│       ├── relay_manager.hpp
│       ├── p2p/
│       │   ├── manager.hpp
│       │   ├── stun_client.hpp
│       │   ├── puncher.hpp
│       │   └── keepalive.hpp
│       ├── endpoint.hpp
│       ├── tun.hpp
│       ├── route.hpp
│       └── crypto_engine.hpp
│
├── config/
│   ├── controller.example.json
│   ├── server.example.json         # Relay/STUN 服务器配置
│   └── client.example.json
│
└── docker/
    ├── Dockerfile.controller
    ├── Dockerfile.server           # Relay/STUN 统一镜像
    └── docker-compose.yml
```

---

## 12. 配置文件

### 12.1 Controller

```json
{
  "listen": {
    "http": "0.0.0.0:443",
    "ws_control": "/ws/control",
    "ws_server": "/ws/server"
  },
  "tls": {
    "cert": "/etc/wss-mesh/cert.pem",
    "key": "/etc/wss-mesh/key.pem"
  },
  "database": {
    "type": "sqlite",
    "path": "/var/lib/wss-mesh/mesh.db"
  },
  "jwt": {
    "secret": "your-secret-key-change-me",
    "algorithm": "HS256"
  },
  "tokens": {
    "auth_expire_hours": 24,
    "relay_expire_hours": 1.5
  },
  "security": {
    "node_key_rotate_hours": 24,
    "require_authorization": true
  },
  "builtin_relay": {
    "enabled": true,
    "ws_data": "/ws/data",
    "ws_mesh": "/ws/mesh"
  },
  "builtin_stun": {
    "enabled": true,
    "listen": "0.0.0.0:3478",
    "external_ip": "203.0.113.1",
    "secondary_ip": "203.0.113.2"
  }
}
```

### 12.2 Server (Relay/STUN 独立部署)

```json
{
  "controller": {
    "url": "wss://controller.example.com/ws/server",
    "token": "server-token-from-controller"
  },
  "jwt": {
    "secret": "same-secret-as-controller"
  },
  "relay": {
    "enabled": true,
    "listen": "0.0.0.0:443",
    "ws_data": "/ws/data",
    "ws_mesh": "/ws/mesh",
    "tls": {
      "cert": "/etc/wss-mesh/cert.pem",
      "key": "/etc/wss-mesh/key.pem"
    }
  },
  "stun": {
    "enabled": true,
    "listen": "0.0.0.0:3478",
    "external_ip": "203.0.113.100",
    "secondary_ip": "203.0.113.101"
  },
  "mesh": {
    "peers": [
      "wss://relay2.example.com/ws/mesh"
    ]
  }
}
```

### 12.3 Client

```json
{
  "controller": "wss://controller.example.com/ws/control",
  "hostname": "my-laptop",
  "key_file": "~/.wss-mesh/keys.json",
  "tun": {
    "name": "wss-mesh0",
    "mtu": 1400
  },
  "advertise_routes": [
    {
      "cidr": "192.168.1.0/24",
      "priority": 100,
      "weight": 50
    }
  ],
  "accept_routes": true,
  "gateway_mode": {
    "enabled": false,
    "snat": true,
    "lan_interface": "eth0"
  },
  "p2p": {
    "enabled": true,
    "keepalive_interval_seconds": 25
  },
  "relay": {
    "connect_all": true,
    "latency_report_interval_seconds": 30
  }
}
```

---

## 13. 开发计划与进度

```
Phase 1: 基础架构 (2周) ✅ 已完成
├── Controller HTTP/WSS 服务器
├── 数据库层 (SQLite + MariaDB)
├── JWT Token 签发/验证
├── 基础 REST API
├── 节点认证流程
└── 配置下发

Phase 2: 安全层 (1.5周) ✅ 已完成
├── X25519 密钥交换
├── ChaCha20-Poly1305 加密
├── Ed25519 签名
├── 密钥轮换机制
├── Token 黑名单
└── 重放攻击防护

Phase 3: Relay/STUN 服务器 (2周) ✅ 已完成
├── 统一的 Server 程序
├── Relay WSS 服务器
├── STUN UDP 服务器
├── Relay Mesh 互联
├── 节点位置同步
├── Token 本地验证
└── Controller 连接

Phase 4: 客户端基础 (2周) ✅ 已完成
├── 控制通道连接
├── 多 Relay 连接管理
├── 配置接收
├── TUN 设备
├── 端到端加密
└── MTU 处理

Phase 5: 延迟与路径 (1周) ✅ 已完成
├── 延迟测量上报
├── 路径计算
├── 最优路径下发
└── 动态路径切换

Phase 6: P2P 直连 (2周) ✅ 已完成
├── STUN 客户端
├── NAT 类型检测
├── 端点收集与交换
├── UDP 打洞
├── NAT Keepalive
└── P2P ↔ Relay 切换

Phase 7: 子网路由 (1周) ✅ 已完成
├── 路由宣告 (优先级/权重)
├── 路由聚合与下发
├── 加权随机选择
├── 故障转移
└── 网关节点配置

Phase 8: Controller 内置功能 + CLI (0.5周) ✅ 完成
├── 内置 Relay
├── 内置 STUN
└── CLI 管理命令 (内置到 controller/client)

Phase 9: 测试与优化 (1周) 📅 计划中
├── 单元测试
├── 集成测试
├── 性能测试
└── 文档完善

总计: ~13 周
当前进度: Phase 8 完成
```

---

## 14. 实现状态总结

### 14.1 已实现功能

| 阶段 | 功能模块 | 完成度 | 备注 |
|------|----------|--------|------|
| Phase 1 | Controller 基础架构 | 100% | HTTP/WSS 服务器, 数据库, JWT, API |
| Phase 2 | 安全层 | 100% | X25519, ChaCha20, Ed25519, HKDF |
| Phase 3 | Relay/STUN Server | 100% | WSS Relay, STUN, Mesh 互联 |
| Phase 4 | 客户端基础 | 100% | TUN, 多 Relay 连接, 加密 |
| Phase 5 | 延迟与路径 | 100% | 延迟测量, 路径计算, 动态切换 |
| Phase 6 | P2P 直连 | 100% | STUN 打洞, NAT Keepalive |
| Phase 7 | 子网路由 | 100% | 优先级/权重, 故障转移 |

### 14.2 代码结构

```
edgelink/
├── src/
│   ├── common/           # 公共库
│   │   ├── crypto/       # X25519, ChaCha20, Ed25519, HKDF
│   │   ├── protocol.*    # 协议定义
│   │   ├── frame.*       # 帧编解码
│   │   ├── jwt.*         # JWT 处理
│   │   ├── config.*      # 配置加载
│   │   └── log.*         # 日志
│   │
│   ├── controller/       # 控制器
│   │   ├── api/          # REST API, WebSocket 处理
│   │   ├── db/           # 数据库层, 迁移
│   │   ├── services/     # 路径计算等服务
│   │   └── main.cpp
│   │
│   ├── server/           # Relay/STUN 服务器
│   │   ├── relay_server.*       # Relay WSS 服务
│   │   ├── relay_session.*      # 客户端会话
│   │   ├── mesh_manager.*       # Mesh 互联管理
│   │   ├── mesh_session.*       # Mesh 会话
│   │   ├── mesh_client.*        # Mesh 客户端
│   │   ├── stun_server.*        # STUN UDP 服务
│   │   ├── controller_client.*  # 连接 Controller
│   │   ├── node_location_cache.*# 节点位置缓存
│   │   └── main.cpp
│   │
│   └── client/           # 客户端
│       ├── control_channel.*    # 控制通道
│       ├── relay_manager.*      # 多 Relay 管理
│       ├── p2p_manager.*        # P2P 直连
│       ├── endpoint_manager.*   # 端点收集
│       ├── crypto_engine.*      # 加密引擎
│       ├── route_manager.*      # 路由管理
│       ├── tun.*                # TUN 设备
│       ├── client.*             # 主逻辑
│       └── main.cpp
│
├── tests/                # 测试
│   ├── test_crypto.cpp
│   ├── test_protocol.cpp
│   └── e2e_test.sh
│
├── config/               # 配置示例
│   ├── controller.example.json
│   ├── server.example.json
│   └── client.example.json
│
└── docs/                 # 文档
    ├── wss-mesh-design.md
    └── PHASE*_STATUS.md
```

### 14.3 待完成工作

| 优先级 | 任务 | 说明 |
|--------|------|------|
| 中 | 单元测试补充 | 提高测试覆盖率 |
| 中 | 集成测试 | 端到端测试场景 |
| 低 | 性能优化 | 大规模节点测试 |
| 低 | Docker 部署 | 容器化打包 |

### 14.4 技术债务

| 项目 | 说明 | 优先级 |
|------|------|--------|
| MariaDB 连接池 | 目前使用单连接 | 中 |
| 路由缓存 | lookup 可添加缓存 | 低 |
| IPv6 支持 | 扩展地址处理 | 低 |
| 配置热加载 | 不重启更新配置 | 低 |

---

*文档结束*
